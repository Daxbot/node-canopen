<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>protocol/lss.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/DaxBot/node-canopen" target="_blank" class="menu-item" id="repository" >Repository</a></h2><h3>Classes</h3><ul><li><a href="DataObject.html">DataObject</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataObject.html#.isDataObject">isDataObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#addSubObject">addSubObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#at">at</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#removeSubObject">removeSubObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#valueOf">valueOf</a></li></ul></li><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Device.html#getDeviceName">getDeviceName</a></li><li data-type='method' style='display: none;'><a href="Device.html#getDeviceType">getDeviceType</a></li><li data-type='method' style='display: none;'><a href="Device.html#getHardwareVersion">getHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Device.html#getSoftwareVersion">getSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Device.html#getStatusRegister">getStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Device.html#mapRemoteNode">mapRemoteNode</a></li><li data-type='method' style='display: none;'><a href="Device.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Device.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Device.html#stop">stop</a></li></ul></li><li><a href="Eds.html">Eds</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Eds.html#.fromFile">fromFile</a></li><li data-type='method' style='display: none;'><a href="Eds.html#.isEds">isEds</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEmcyConsumer">addEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEntry">addEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addHeartbeatConsumer">addHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addReceivePdo">addReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoClientParameter">addSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoServerParameter">addSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSubEntry">addSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addTransmitPdo">addTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#findEntry">findEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEntry">getEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getRaw">getRaw</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getRawArray">getRawArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getScale">getScale</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getScaleArray">getScaleArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSubEntry">getSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getValue">getValue</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getValueArray">getValueArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Eds.html#pushErrorHistory">pushErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEmcyConsumer">removeEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEntry">removeEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeHeartbeatConsumer">removeHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeReceivePdo">removeReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoClientParameter">removeSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoServerParameter">removeSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSubEntry">removeSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeTransmitPdo">removeTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#reset">reset</a></li><li data-type='method' style='display: none;'><a href="Eds.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceName">setDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceType">setDeviceType</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyCobId">setEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyInhibitTime">setEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorHistoryLength">setErrorHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorRegister">setErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHardwareVersion">setHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHeartbeatProducerTime">setHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setIdentity">setIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setRaw">setRaw</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setRawArray">setRawArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setScaleArray">setScaleArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSoftwareVersion">setSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setStatusRegister">setStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCobId">setSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCyclePeriod">setSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncOverflow">setSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeCobId">setTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setValue">setValue</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setValueArray">setValueArray</a></li></ul></li><li><a href="EdsError.html">EdsError</a></li><li><a href="Emcy.html">Emcy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Emcy.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#write">write</a></li></ul></li><li><a href="EmcyMessage.html">EmcyMessage</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EmcyMessage.html#.isMessage">isMessage</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toBuffer">toBuffer</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toString">toString</a></li></ul></li><li><a href="Lss.html">Lss</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Lss.html#activateBitTiming">activateBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureBitTiming">configureBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureNodeId">configureNodeId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#fastscan">fastscan</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireProductCode">inquireProductCode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireRevisionNumber">inquireRevisionNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireSerialNumber">inquireSerialNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireVendorId">inquireVendorId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Lss.html#setMode">setMode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Lss.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Lss.html#storeConfiguration">storeConfiguration</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeGlobal">switchModeGlobal</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeSelective">switchModeSelective</a></li></ul></li><li><a href="LssError.html">LssError</a></li><li><a href="Nmt.html">Nmt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Nmt.html#enterPreOperational">enterPreOperational</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumerTime">getConsumerTime</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getNodeState">getNodeState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetCommunication">resetCommunication</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetNode">resetNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#setState">setState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#startNode">startNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stopNode">stopNode</a></li></ul></li><li><a href="Pdo.html">Pdo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Pdo.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#write">write</a></li></ul></li><li><a href="Protocol.html">Protocol</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Protocol.html#send">send</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#stop">stop</a></li></ul></li><li><a href="SdoClient.html">SdoClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoClient.html#download">download</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#upload">upload</a></li></ul></li><li><a href="SdoError.html">SdoError</a><ul class='members'><li data-type='member' style='display: none;'><a href="SdoError.html#.SdoCode">SdoCode</a></li></ul></li><li><a href="SdoServer.html">SdoServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoServer.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#stop">stop</a></li></ul></li><li><a href="Sync.html">Sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Sync.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Sync.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Sync.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Sync.html#write">write</a></li></ul></li><li><a href="Time.html">Time</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Time.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Time.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Time.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Time.html#write">write</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="DataObject.html#event:update">DataObject#update</a></li><li><a href="Emcy.html#event:emergency">Emcy#emergency</a></li><li><a href="Lss.html#event:changeDeviceId">Lss#changeDeviceId</a></li><li><a href="Lss.html#event:changeMode">Lss#changeMode</a></li><li><a href="Nmt.html#event:changeState">Nmt#changeState</a></li><li><a href="Nmt.html#event:reset">Nmt#reset</a></li><li><a href="Nmt.html#event:timeout">Nmt#timeout</a></li><li><a href="Pdo.html#event:pdo">Pdo#pdo</a></li><li><a href="Protocol.html#event:message">Protocol#message</a></li><li><a href="Protocol.html#event:start">Protocol#start</a></li><li><a href="Protocol.html#event:stop">Protocol#stop</a></li><li><a href="Sync.html#event:sync">Sync#sync</a></li><li><a href="Time.html#event:time">Time#time</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AccessType">AccessType</a></li><li><a href="global.html#calculateCrc">calculateCrc</a></li><li><a href="global.html#DataType">DataType</a></li><li><a href="global.html#dateToTime">dateToTime</a></li><li><a href="global.html#EmcyCode">EmcyCode</a></li><li><a href="global.html#EmcyType">EmcyType</a></li><li><a href="global.html#LssMode">LssMode</a></li><li><a href="global.html#NmtState">NmtState</a></li><li><a href="global.html#ObjectType">ObjectType</a></li><li><a href="global.html#rawToType">rawToType</a></li><li><a href="global.html#timeToDate">timeToDate</a></li><li><a href="global.html#typeToRaw">typeToRaw</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">protocol/lss.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Implements the CANopen Layer Setting Services (LSS) protocol.
 * @author Wilkins White
 * @copyright 2024 Daxbot
 */

const Protocol = require('./protocol');
const { Eds } = require('../eds');
const { deprecate } = require('util');

/**
 * CANopen LSS command specifiers.
 *
 * @enum {number}
 * @see CiA305 "LSS Protocol Descriptions" (§3.8.2)
 * @private
 */
const LssCommand = {
    SWITCH_MODE_GLOBAL: 4,
    CONFIGURE_NODE_ID: 17,
    CONFIGURE_BIT_TIMING: 19,
    ACTIVATE_BIT_TIMING: 21,
    STORE_CONFIGURATION: 23,
    SWITCH_MODE_VENDOR_ID: 64,
    SWITCH_MODE_PRODUCT_CODE: 65,
    SWITCH_MODE_REVISION_NUMBER: 66,
    SWITCH_MODE_SERIAL_NUMBER: 67,
    FASTSCAN: 81,
    INQUIRE_VENDOR_ID: 90,
    INQUIRE_PRODUCT_CODE: 91,
    INQUIRE_REVISION_NUMBER: 92,
    INQUIRE_SERIAL_NUMBER: 93,
};

/**
 * CANopen LSS modes.
 *
 * @enum {number}
 * @see CiA305 "Switch Mode Global" (§3.9.1)
 */
const LssMode = {
    /** Only the switch mode service is available. */
    OPERATION: 0,

    /** All LSS services are available. */
    CONFIGURATION: 1,
};

/**
 * Errors generated during LSS services.
 *
 * @param {object} args - arguments.
 * @param {string} args.message - error message.
 * @param {number} args.code - error code.
 * @param {number} args.info - error info code.
 */
class LssError extends Error {
    constructor(...args) {
        if(typeof args[0] === 'object') {
            args = args[0];
        }
        else {
            args = {
                message: args[0],
                code: args[1],
                info: args[2],
            };
        }

        super(args.message);
        this.code = args.code;
        this.info = args.info;

        this.name = this.constructor.name;
        Error.captureStackTrace(this, this.constructor);
    }
}

/**
 * CANopen LSS protocol handler.
 *
 * @param {Eds} eds - Eds object.
 * @see CiA305 "Layer Settings Services and Protocol (LSS)"
 */
class Lss extends Protocol {
    constructor(eds) {
        super();

        if(!Eds.isEds(eds))
            throw new TypeError('not an Eds');

        this.eds = eds;
        this._mode = LssMode.OPERATION;
        this.pending = {};
        this.select = [];
        this.scanState = 0;
    }

    /**
     * Device LSS Mode.
     *
     * @type {LssMode}
     */
    get mode() {
        return this._mode;
    }

    set mode(value) {
        this.setMode(value);
    }

    /**
     * Vendor id.
     *
     * @type {number}
     */
    get vendorId() {
        if(this._vendorId !== undefined)
            return this._vendorId;

        return this.eds.getValueArray(0x1018, 1);
    }

    set vendorId(value) {
        this._vendorId = value;
    }

    /**
     * Product code.
     *
     * @type {number}
     */
    get productCode() {
        if(this._productCode !== undefined)
            return this._productCode;

        return this.eds.getValueArray(0x1018, 2);
    }

    set productCode(value) {
        this._productCode = value;
    }

    /**
     * Revision number.
     *
     * @type {number}
     */
    get revisionNumber() {
        if(this._revisionNumber !== undefined)
            return this._revisionNumber;

        return this.eds.getValueArray(0x1018, 3);
    }

    set revisionNumber(value) {
        this._revisionNumber = value;
    }

    /**
     * Serial number.
     *
     * @type {number}
     */
    get serialNumber() {
        if(this._serialNumber !== undefined)
            return this._serialNumber;

        return this.eds.getValueArray(0x1018, 4);
    }

    set serialNumber(value) {
        this._serialNumber = value;
    }

    /**
     * Start the module.
     *
     * @fires Protocol#start
     */
    start() {
        super.start();
    }

    /**
     * Stop the module.
     *
     * @fires Protocol#stop
     */
    stop() {
        super.stop();
    }

    /**
     * Set the LSS mode.
     *
     * @param {LssMode} mode - new mode.
     * @fires Lss#changeMode
     */
    setMode(mode) {
        if(mode !== this._mode) {
            this._mode = mode;

            /**
             * The LSS mode changed.
             *
             * @event Lss#changeMode
             * @type {LssMode}
             */
            this.emit('changeMode', mode);
        }
    }

    /**
     * LSS Fastscan protocol.
     *
     * Identifies exactly one LSS consumer device and switches it to
     * configuration mode.
     *
     * @param {object} [args] - arguments.
     * @param {number} [args.vendorId] - vendor-id hint.
     * @param {number} [args.productCode] - product-code hint.
     * @param {number} [args.revisionNumber] - revision-number hint.
     * @param {number} [args.serialNumber] - serial-number hint.
     * @param {number} [args.timeout] - how long to wait for nodes to respond.
     * @returns {Promise&lt;null | object>} resolves to the discovered device's id (or null).
     * @fires Protocol#message
     * @see https://www.can-cia.org/fileadmin/resources/documents/proceedings/2008_pfeiffer.pdf
     */
    async fastscan(args={}) {
        let vendorId = args.vendorId;
        let productCode = args.productCode;
        let revisionNumber = args.revisionNumber;
        let serialNumber = args.serialNumber;
        let timeout = args.timeout || 20;
        let timeoutFlag = false;

        // Initiate fastscan
        await new Promise((resolve) => {
            const timer = setTimeout(() => {
                timeoutFlag = true;
                resolve();
            }, timeout);

            this._sendLssRequest(
                LssCommand.FASTSCAN, Buffer.from([0, 0, 0, 0, 0x80]));

            this.pending[0x4f] = { resolve, timer };
        });

        if (timeoutFlag)
            return null; // No devices

        // Find vendor-id
        if (vendorId === undefined) {
            vendorId = 0;
            for (let i = 31; i >= 0; --i) {
                await new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        const bit = (1 &lt;&lt; i) >>> 0;
                        vendorId = (vendorId | bit) >>> 0;
                        resolve();
                    }, timeout);

                    const data = Buffer.alloc(7);
                    data.writeUInt32LE(vendorId);
                    data[4] = i; // Bit checked
                    data[5] = 0; // LSS sub
                    data[6] = 0; // LSS next
                    this._sendLssRequest(LssCommand.FASTSCAN, data);

                    this.pending[0x4f] = { resolve, timer };
                });
            }
        }

        // Verify vendor-id
        await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('unverified vendorId', 255, 0));
            }, timeout);

            const data = Buffer.alloc(7);
            data.writeUInt32LE(vendorId);
            data[4] = 0; // Bit checked
            data[5] = 0; // LSS sub
            data[6] = 1; // LSS next
            this._sendLssRequest(LssCommand.FASTSCAN, data);

            this.pending[0x4f] = { resolve, timer };
        });

        // Find product-code
        if (productCode === undefined) {
            productCode = 0;
            for (let i = 31; i >= 0; --i) {
                await new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        const bit = (1 &lt;&lt; i) >>> 0;
                        productCode = (productCode | bit) >>> 0;
                        resolve();
                    }, timeout);

                    const data = Buffer.alloc(7);
                    data.writeUInt32LE(productCode);
                    data[4] = i; // Bit checked
                    data[5] = 1; // LSS sub
                    data[6] = 1; // LSS next
                    this._sendLssRequest(LssCommand.FASTSCAN, data);

                    this.pending[0x4f] = { resolve, timer };
                });
            }
        }

        // Verify product-code
        await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('unverified productCode', 255, 0));
            }, timeout);

            const data = Buffer.alloc(7);
            data.writeUInt32LE(productCode);
            data[4] = 0; // Bit checked
            data[5] = 1; // LSS sub
            data[6] = 2; // LSS next
            this._sendLssRequest(LssCommand.FASTSCAN, data);

            this.pending[0x4f] = { resolve, timer };
        });

        // Find revision-number
        if (revisionNumber === undefined) {
            revisionNumber = 0;
            for (let i = 31; i >= 0; --i) {
                await new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        const bit = (1 &lt;&lt; i) >>> 0;
                        revisionNumber = (revisionNumber | bit) >>> 0;
                        resolve();
                    }, timeout);

                    const data = Buffer.alloc(7);
                    data.writeUInt32LE(revisionNumber);
                    data[4] = i; // Bit checked
                    data[5] = 2; // LSS sub
                    data[6] = 2; // LSS next
                    this._sendLssRequest(LssCommand.FASTSCAN, data);

                    this.pending[0x4f] = { resolve, timer };
                });
            }
        }

        // Verify revision-number
        await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('unverified revisionNumber', 255, 0));
            }, timeout);

            const data = Buffer.alloc(7);
            data.writeUInt32LE(revisionNumber);
            data[4] = 0; // Bit checked
            data[5] = 2; // LSS sub
            data[6] = 3; // LSS next
            this._sendLssRequest(LssCommand.FASTSCAN, data);

            this.pending[0x4f] = { resolve, timer };
        });

        // Find serial-number
        if (serialNumber === undefined) {
            serialNumber = 0;
            for (let i = 31; i >= 0; --i) {
                await new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        const bit = (1 &lt;&lt; i) >>> 0;
                        serialNumber = (serialNumber | bit) >>> 0;
                        resolve();
                    }, timeout);

                    const data = Buffer.alloc(7);
                    data.writeUInt32LE(serialNumber);
                    data[4] = i; // Bit checked
                    data[5] = 3; // LSS sub
                    data[6] = 3; // LSS next
                    this._sendLssRequest(LssCommand.FASTSCAN, data);

                    this.pending[0x4f] = { resolve, timer };
                });
            }
        }

        // Verify serial-number
        await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('unverified serialNumber', 255, 0));
            }, timeout);

            const data = Buffer.alloc(7);
            data.writeUInt32LE(serialNumber);
            data[4] = 0; // Bit checked
            data[5] = 3; // LSS sub
            data[6] = 0; // LSS next
            this._sendLssRequest(LssCommand.FASTSCAN, data);

            this.pending[0x4f] = { resolve, timer };
        });

        return { vendorId, productCode, revisionNumber, serialNumber };
    }

    /**
     * Service: switch mode global.
     *
     * @param {LssMode} mode - LSS mode to switch to.
     * @fires Protocol#message
     * @see CiA305 "Switch Mode Global" (§3.9.1)
     */
    switchModeGlobal(mode) {
        if (mode === undefined)
            throw ReferenceError('mode not defined');

        this._sendLssRequest(
            LssCommand.SWITCH_MODE_GLOBAL, Buffer.from([mode]));
    }

    /**
     * Service: switch mode selective.
     *
     * @param {object} args - arguments.
     * @param {number} args.vendorId - LSS consumer vendor-id.
     * @param {number} args.productCode - LSS consumer product-code.
     * @param {number} args.revisionNumber - LSS consumer revision-number.
     * @param {number} args.serialNumber - LSS consumer serial-number.
     * @param {number} [args.timeout] - time until promise is rejected.
     * @returns {Promise&lt;LssMode>} - the actual mode of the LSS consumer.
     * @fires Protocol#message
     * @see CiA305 "Switch Mode Selective" (§3.9.2)
     */
    switchModeSelective(...args) {
        if(typeof args[0] === 'object') {
            args = args[0];
        }
        else {
            args = {
                vendorId: args[0],
                productCode: args[1],
                revisionNumber: args[2],
                serialNumber: args[3],
                timeout: args[4],
            };
        }

        return new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('timeout'));
            }, args.timeout);

            const data = Buffer.alloc(4);

            // Send vendor-id
            data.writeUInt32LE(args.vendorId);
            this._sendLssRequest(LssCommand.SWITCH_MODE_VENDOR_ID, data);

            // Send product-code
            data.writeUInt32LE(args.productCode);
            this._sendLssRequest(LssCommand.SWITCH_MODE_PRODUCT_CODE, data);

            // Send revision-number
            data.writeUInt32LE(args.revisionNumber);
            this._sendLssRequest(LssCommand.SWITCH_MODE_REVISION_NUMBER, data);

            // Send serial-number
            data.writeUInt32LE(args.serialNumber);
            this._sendLssRequest(LssCommand.SWITCH_MODE_SERIAL_NUMBER, data);

            this.pending[68] = { resolve, timer };
        });
    }

    /**
     * Service: configure node-id.
     *
     * @param {number} nodeId - new node-id
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise} resolves when the service is finished.
     * @fires Protocol#message
     * @see CiA305 "Configure Node-ID Protocol" (§3.10.1)
     */
    async configureNodeId(nodeId, timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('timeout'));
            }, timeout);

            this._sendLssRequest(
                LssCommand.CONFIGURE_NODE_ID, Buffer.from([nodeId]));

            this.pending[LssCommand.CONFIGURE_NODE_ID] = {
                resolve,
                timer
            };
        });

        let message = '';
        switch (result[0]) {
            case 0:
                return; // Success
            case 1:
                message = 'Node-ID out of range';
                break;
            case 255:
                message = 'Implementation specific error';
                break;
            default:
                message = 'Unsupported error code';
                break;
        }

        throw new LssError(message, result[0], result[1]);
    }

    /**
     * Service: configure bit timing parameters.
     *
     * @param {number} tableSelect - which bit timing parameters table to use.
     * @param {number} tableIndex - the entry in the selected table to use.
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise} resolves when the service is finished.
     * @fires Protocol#message
     * @see CiA305 "Configure Bit Timing Parameters Protocol" (§3.10.2)
     */
    async configureBitTiming(tableSelect, tableIndex, timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('timeout'));
            }, timeout);

            this._sendLssRequest(
                LssCommand.CONFIGURE_BIT_TIMING,
                Buffer.from([tableSelect, tableIndex]));

            this.pending[LssCommand.CONFIGURE_BIT_TIMING] = {
                resolve,
                timer
            };
        });

        let message = '';
        switch (result[0]) {
            case 0:
                return; // Success
            case 1:
                message = 'Bit timing not supported';
                break;
            case 255:
                message = 'Implementation specific error';
                break;
            default:
                message = 'Unsupported error code';
                break;
        }

        throw new LssError(message, result[0], result[1]);
    }

    /**
     * Service: activate bit timing parameters.
     *
     * @param {number} delay - switch delay in ms.
     * @fires Protocol#message
     * @see CiA305 "Activate Bit Timing Parameters Protocol" (§3.10.3)
     */
    activateBitTiming(delay) {
        const switchDelay = Buffer.alloc(2);
        switchDelay.writeUInt16LE(delay);
        this._sendLssRequest(LssCommand.ACTIVATE_BIT_TIMING, switchDelay);
    }

    /**
     * Service: store configuration.
     *
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise} resolves when the service is finished.
     * @fires Protocol#message
     * @see CiA305 "Store Configuration Protocol" (§3.10.4)
     */
    async storeConfiguration(timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new LssError('timeout'));
            }, timeout);

            this._sendLssRequest(LssCommand.STORE_CONFIGURATION);

            this.pending[LssCommand.STORE_CONFIGURATION] = {
                resolve,
                timer
            };
        });

        let message = '';
        switch (result[0]) {
            case 0:
                return; // Success
            case 1:
                message = 'Store configuration not supported';
                break;
            case 2:
                message = 'Storage media access error';
                break;
            case 255:
                message = 'Implementation specific error';
                break;
            default:
                message = 'Unsupported error code';
                break;
        }

        throw new LssError(message, result[0], result[1]);
    }

    /**
     * Service: inquire identity vendor-id.
     *
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise&lt;number>} - LSS consumer vendor-id.
     * @fires Protocol#message
     * @see CiA305 "Inquire Identity Vendor-ID Protocol" (§3.11.1.1)
     */
    async inquireVendorId(timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(
                () => reject(new LssError('timeout')), timeout);

            this._sendLssRequest(LssCommand.INQUIRE_VENDOR_ID);

            this.pending[LssCommand.INQUIRE_VENDOR_ID] = {
                resolve,
                timer
            };
        });

        return result.readUInt32LE();
    }

    /**
     * Service: inquire identity product-code.
     *
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise&lt;number>} - LSS consumer product-code.
     * @fires Protocol#message
     * @see CiA305 "Inquire Identity Product-Code Protocol" (§3.11.1.2)
     */
    async inquireProductCode(timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(
                () => reject(new LssError('timeout')), timeout);

            this._sendLssRequest(LssCommand.INQUIRE_PRODUCT_CODE);

            this.pending[LssCommand.INQUIRE_PRODUCT_CODE] = {
                resolve,
                timer
            };
        });

        return result.readUInt32LE();
    }

    /**
     * Service: inquire identity revision-number.
     *
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise&lt;number>} - LSS consumer revision-number.
     * @fires Protocol#message
     * @see CiA305 "Inquire Identity Revision-Number Protocol" (§3.11.1.3)
     */
    async inquireRevisionNumber(timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(
                () => reject(new LssError('timeout')), timeout);

            this._sendLssRequest(LssCommand.INQUIRE_REVISION_NUMBER);

            this.pending[LssCommand.INQUIRE_REVISION_NUMBER] = {
                resolve,
                timer
            };
        });

        return result.readUInt32LE();
    }

    /**
     * Service: inquire identity serial-number.
     *
     * @param {number} timeout - time until promise is rejected.
     * @returns {Promise&lt;number>} - LSS consumer serial-number.
     * @fires Protocol#message
     * @see CiA305 "Inquire Identity Serial-Number Protocol" (§3.11.1.4)
     */
    async inquireSerialNumber(timeout = 20) {
        const result = await new Promise((resolve, reject) => {
            const timer = setTimeout(
                () => reject(new LssError('timeout')), timeout);

            this._sendLssRequest(LssCommand.INQUIRE_SERIAL_NUMBER);

            this.pending[LssCommand.INQUIRE_SERIAL_NUMBER] = {
                resolve,
                timer
            };
        });

        return result.readUInt32LE();
    }

    /**
     * Call when a new CAN message is received.
     *
     * @param {object} message - CAN frame.
     * @param {number} message.id - CAN message identifier.
     * @param {Buffer} message.data - CAN message data;
     * @fires Lss#changeMode
     * @fires Lss#changeDeviceId
     */
    receive({ id, data }) {
        if (id === 0x7e4) {
            const cs = data[0];
            if (this.pending[cs] !== undefined) {
                clearTimeout(this.pending[cs].timer);
                this.pending[cs].resolve(data.slice(1));
            }
        }
        else if (id === 0x7e5) {
            const cs = data[0];

            if (cs === LssCommand.FASTSCAN) {
                // Fastscan is only available for unconfigured nodes.
                const bitCheck = data[5];
                const lssSub = data[6];
                const lssNext = data[7];

                if (bitCheck === 0x80) {
                    // Reset state
                    this.scanState = 0;
                    this._sendLssResponse(0x4f);
                }
                else if (this.scanState === lssSub) {
                    if (bitCheck > 0x1f || lssSub > 3 || lssNext > 3)
                        return; // Invalid request

                    const value = data.readUInt32LE(1);
                    const mask = (0xffffffff &lt;&lt; bitCheck) >>> 0;
                    let match = false;

                    switch (lssSub) {
                        case 0:
                            // Test vendor id
                            match = this._maskCompare(
                                this.vendorId, value, mask);
                            break;

                        case 1:
                            // Test product code
                            match = this._maskCompare(
                                this.productCode, value, mask);
                            break;

                        case 2:
                            // Test revision number
                            match = this._maskCompare(
                                this.revisionNumber, value, mask);
                            break;

                        case 3:
                            match = this._maskCompare(
                                this.serialNumber, value, mask);
                            break;
                    }

                    if (match) {
                        this.scanState = lssNext;
                        if (bitCheck === 0 &amp;&amp; lssNext &lt; lssSub)
                            this.setMode(LssMode.CONFIGURATION);

                        this._sendLssResponse(0x4f);
                    }
                }
                return;
            }

            // Switch mode commands
            switch (cs) {
                case LssCommand.SWITCH_MODE_GLOBAL:
                    this.setMode(data[1]);
                    this.select = [];
                    return;

                case LssCommand.SWITCH_MODE_VENDOR_ID:
                    this.select[0] = data.readUInt32LE(1);
                    return;

                case LssCommand.SWITCH_MODE_PRODUCT_CODE:
                    this.select[1] = data.readUInt32LE(1);
                    return;

                case LssCommand.SWITCH_MODE_REVISION_NUMBER:
                    this.select[2] = data.readUInt32LE(1);
                    return;

                case LssCommand.SWITCH_MODE_SERIAL_NUMBER:
                    this.select[3] = data.readUInt32LE(1);
                    if (this._checkLssAddress(this.select))
                        this.setMode(LssMode.CONFIGURATION);
                    return;
            }

            // Configuration commands
            if (this.mode !== LssMode.CONFIGURATION)
                return;

            switch (cs) {
                case LssCommand.CONFIGURE_NODE_ID:
                    try {
                        /**
                         * LssCommand.CONFIGURE_NODE_ID was received.
                         *
                         * @event Lss#changeDeviceId
                         * @type {number}
                         */
                        this.emit('changeDeviceId', data[1]);
                        this._sendLssResponse(cs, 0);
                    }
                    catch {
                        // Error: Node-ID out of range
                        this._sendLssResponse(cs, 1);
                    }
                    return;

                case LssCommand.CONFIGURE_BIT_TIMING:
                    // Error: Bit timing not supported
                    this._sendLssResponse(cs, 1);
                    return;

                case LssCommand.STORE_CONFIGURATION:
                    // Error: Store configuration not supported
                    this._sendLssResponse(cs, 1);
                    return;

                case LssCommand.INQUIRE_VENDOR_ID:
                    this._sendLssResponse(cs, this.vendorId);
                    return;

                case LssCommand.INQUIRE_PRODUCT_CODE:
                    this._sendLssResponse(cs, this.productCode);
                    return;

                case LssCommand.INQUIRE_REVISION_NUMBER:
                    this._sendLssResponse(cs, this.revisionNumber);
                    return;

                case LssCommand.INQUIRE_SERIAL_NUMBER:
                    this._sendLssResponse(cs, this.serialNumber);
                    return;
            }
        }
    }

    /////////////////////////////// Private ////////////////////////////////

    /**
     * Send an LSS request object.
     *
     * @param {LssCommand} command - LSS command specifier.
     * @param {Buffer} data - command data.
     * @fires Protocol#message
     * @private
     */
    _sendLssRequest(command, data) {
        const sendBuffer = Buffer.alloc(8);
        sendBuffer[0] = command;

        if (data !== undefined)
            data.copy(sendBuffer, 1);

        this.send(0x7e5, sendBuffer);
    }

    /**
     * Send an LSS response object.
     *
     * @param {LssCommand} command - LSS command specifier.
     * @param {number} code - response code.
     * @param {number} info - response info.
     * @fires Protocol#message
     * @private
     */
    _sendLssResponse(command, code, info = 0) {
        const sendBuffer = Buffer.alloc(8);
        sendBuffer[0] = command;
        sendBuffer[1] = code;
        sendBuffer[2] = info;

        this.send(0x7e4, sendBuffer);
    }

    /**
     * Check an Lss address against the device address.
     *
     * @param {Array} address - Lss address.
     * @param {number} address.0 - device vendor id.
     * @param {number} address.1 - device product code.
     * @param {number} address.2 - device revision number.
     * @param {number} address.3 - device serial number.
     * @returns {boolean} true if the address matches.
     * @private
     */
    _checkLssAddress(address) {
        return address[0] === this.vendorId
            &amp;&amp; address[1] === this.productCode
            &amp;&amp; address[2] === this.revisionNumber
            &amp;&amp; address[3] === this.serialNumber;
    }

    /**
     * Mask and compare two unsigned integers.
     *
     * @param {number} a - first number.
     * @param {number} b - second number.
     * @param {number} mask - bit mask.
     * @returns {boolean} true if the masked values are equal.
     * @private
     */
    _maskCompare(a, b, mask) {
        a = (a &amp; mask) >>> 0;
        b = (b &amp; mask) >>> 0;

        return a === b;
    }

    ////////////////////////////// Deprecated //////////////////////////////

    /**
     * Initialize the device and audit the object dictionary.
     *
     * @deprecated
     * @ignore
     */
    init() {
        deprecate(() => this.start(),
            'init() is deprecated. Use start() instead.');
    }
}

module.exports = exports = { LssMode, LssError, Lss };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
