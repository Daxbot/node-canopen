<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>protocol/pdo.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/DaxBot/node-canopen" target="_blank" class="menu-item" id="repository" >Repository</a></h2><h3>Classes</h3><ul><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Device.html#getRaw">getRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#getRawArray">getRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValue">getValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValueArray">getValueArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Device.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Device.html#send">send</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRaw">setRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRawArray">setRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#setTransmitFunction">setTransmitFunction</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValue">setValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValueArray">setValueArray</a></li></ul></li><li><a href="Eds.html">Eds</a><ul class='members'><li data-type='member' style='display: none;'><a href="Eds.html#.AccessType">AccessType</a></li><li data-type='member' style='display: none;'><a href="Eds.html#.DataType">DataType</a></li><li data-type='member' style='display: none;'><a href="Eds.html#.ObjectType">ObjectType</a></li><li data-type='member' style='display: none;'><a href="Eds.html#baudRates">baudRates</a></li><li data-type='member' style='display: none;'><a href="Eds.html#createdBy">createdBy</a></li><li data-type='member' style='display: none;'><a href="Eds.html#creationDate">creationDate</a></li><li data-type='member' style='display: none;'><a href="Eds.html#description">description</a></li><li data-type='member' style='display: none;'><a href="Eds.html#dynamicChannelsSupported">dynamicChannelsSupported</a></li><li data-type='member' style='display: none;'><a href="Eds.html#edsVersion">edsVersion</a></li><li data-type='member' style='display: none;'><a href="Eds.html#fileName">fileName</a></li><li data-type='member' style='display: none;'><a href="Eds.html#fileRevision">fileRevision</a></li><li data-type='member' style='display: none;'><a href="Eds.html#fileVersion">fileVersion</a></li><li data-type='member' style='display: none;'><a href="Eds.html#granularity">granularity</a></li><li data-type='member' style='display: none;'><a href="Eds.html#groupMessaging">groupMessaging</a></li><li data-type='member' style='display: none;'><a href="Eds.html#lssSupported">lssSupported</a></li><li data-type='member' style='display: none;'><a href="Eds.html#modificationDate">modificationDate</a></li><li data-type='member' style='display: none;'><a href="Eds.html#modifiedBy">modifiedBy</a></li><li data-type='member' style='display: none;'><a href="Eds.html#nrOfRXPDO">nrOfRXPDO</a></li><li data-type='member' style='display: none;'><a href="Eds.html#nrOfTXPDO">nrOfTXPDO</a></li><li data-type='member' style='display: none;'><a href="Eds.html#orderCode">orderCode</a></li><li data-type='member' style='display: none;'><a href="Eds.html#productName">productName</a></li><li data-type='member' style='display: none;'><a href="Eds.html#productNumber">productNumber</a></li><li data-type='member' style='display: none;'><a href="Eds.html#revisionNumber">revisionNumber</a></li><li data-type='member' style='display: none;'><a href="Eds.html#simpleBootUpMaster">simpleBootUpMaster</a></li><li data-type='member' style='display: none;'><a href="Eds.html#simpleBootUpSlave">simpleBootUpSlave</a></li><li data-type='member' style='display: none;'><a href="Eds.html#vendorName">vendorName</a></li><li data-type='member' style='display: none;'><a href="Eds.html#vendorNumber">vendorNumber</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Eds.html#.rawToType">rawToType</a></li><li data-type='method' style='display: none;'><a href="Eds.html#.typeToRaw">typeToRaw</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEntry">addEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSubEntry">addSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEntry">getEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSubEntry">getSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEntry">removeEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSubEntry">removeSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#save">save</a></li></ul></li><li><a href="Eds.DataObject.html">Eds.DataObject</a></li><li><a href="Eds.EdsError.html">Eds.EdsError</a></li><li><a href="Emcy.html">Emcy</a><ul class='members'><li data-type='member' style='display: none;'><a href="Emcy.html#.EmcyCode">EmcyCode</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#.EmcyType">EmcyType</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#cobId">cobId</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#errorRegister">errorRegister</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#history">history</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#inhibitTime">inhibitTime</a></li><li data-type='member' style='display: none;'><a href="Emcy.html#valid">valid</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Emcy.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#setHistoryLength">setHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#write">write</a></li></ul></li><li><a href="Emcy.EmcyMessage.html">Emcy.EmcyMessage</a></li><li><a href="Lss.html">Lss</a><ul class='members'><li data-type='member' style='display: none;'><a href="Lss.html#.LssCommand">LssCommand</a></li><li data-type='member' style='display: none;'><a href="Lss.html#.LssMode">LssMode</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Lss.html#activateBitTiming">activateBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureBitTiming">configureBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureNodeId">configureNodeId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#fastscan">fastscan</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireProductCode">inquireProductCode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireRevisionNumber">inquireRevisionNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireSerialNumber">inquireSerialNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireVendorId">inquireVendorId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#storeConfiguration">storeConfiguration</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeGlobal">switchModeGlobal</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeSelective">switchModeSelective</a></li></ul></li><li><a href="Lss.LssError.html">Lss.LssError</a></li><li><a href="Nmt.html">Nmt</a><ul class='members'><li data-type='member' style='display: none;'><a href="Nmt.html#.NmtCommand">NmtCommand</a></li><li data-type='member' style='display: none;'><a href="Nmt.html#.NmtState">NmtState</a></li><li data-type='member' style='display: none;'><a href="Nmt.html#producerTime">producerTime</a></li><li data-type='member' style='display: none;'><a href="Nmt.html#producerTime">producerTime</a></li><li data-type='member' style='display: none;'><a href="Nmt.html#state">state</a></li><li data-type='member' style='display: none;'><a href="Nmt.html#state">state</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Nmt.html#enterPreOperational">enterPreOperational</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetCommunication">resetCommunication</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetNode">resetNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#startNode">startNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stopNode">stopNode</a></li></ul></li><li><a href="Pdo.html">Pdo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Pdo.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#write">write</a></li></ul></li><li><a href="Sdo.html">Sdo</a><ul class='members'><li data-type='member' style='display: none;'><a href="Sdo.html#.AbortCode">AbortCode</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Sdo.html#download">download</a></li><li data-type='method' style='display: none;'><a href="Sdo.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Sdo.html#upload">upload</a></li></ul></li><li><a href="Sdo.SdoError.html">Sdo.SdoError</a></li><li><a href="Sync.html">Sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Sync.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Sync.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Sync.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Sync.html#write">write</a></li></ul></li><li><a href="Time.html">Time</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Time.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Time.html#write">write</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">protocol/pdo.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Implements the CANopen Process Data Object (PDO) protocol.
 * @author Wilkins White
 * @copyright 2021 Nova Dynamics LLC
 */

const Device = require('../device');
const { DataObject } = require('../eds');

/**
 * CANopen PDO protocol handler.
 *
 * The process data object (PDO) protocol follows a producer-consumer structure
 * where one device broadcasts data that can be consumed by any device on the
 * network. Unlike the SDO protocol, PDO transfers are performed with no
 * protocol overhead.
 *
 * @param {Device} device - parent device.
 * @see CiA301 "Process data objects (PDO)" (§7.2.2)
 * @protected
 */
class Pdo {
    constructor(device) {
        this.device = device;
        this.receiveMap = {};
        this.writeMap = {};
        this.eventTimers = {};
        this.events = [];
    }

    /** Initialize members and begin RPDO monitoring. */
    init() {
        this.load();
        this.device.addListener('message', this._onMessage.bind(this));
    }

    /** Load PDO configuration.  */
    load() {
        this.receiveMap = {};
        this.writeMap = {};

        for(let [index, entry] of Object.entries(this.device.dataObjects)) {
            index = parseInt(index);
            if((index &amp; 0xFF00) == 0x1400 || (index &amp; 0xFF00) == 0x1500) {
                // Object 0x1400..0x15FF - RPDO communication parameter
                if(entry[1] === undefined) {
                    index = `0x${index.toString(16)}`;
                    throw ReferenceError(
                        `COB-ID is mandatory for RPDO (${index})`);
                }

                if(entry[2] === undefined) {
                    index = `0x${index.toString(16)}`;
                    throw ReferenceError(
                        `transmission type is mandatory for RPDO (${index})`);
                }

                const pdo = this._parsePDO(index, entry);
                if(pdo)
                    this.receiveMap[pdo.cobId] = pdo;
            }
            else if((index &amp; 0xFF00) == 0x1800 || (index &amp; 0xFF00) == 0x1900) {
                // Object 0x1800..0x19FF - TPDO communication parameter
                if(entry[1] === undefined) {
                    index = `0x${index.toString(16)}`;
                    throw ReferenceError(
                        `COB-ID is mandatory for TPDO (${index})`);
                }

                if(entry[2] === undefined) {
                    index = `0x${index.toString(16)}`;
                    throw ReferenceError(
                        `transmission type is mandatory for TPDO (${index})`);
                }

                const pdo = this._parsePDO(index, entry);
                if(pdo)
                    this.writeMap[pdo.cobId] = pdo;
            }
        }
    }

    /** Begin TPDO generation. */
    start() {
        for(const [cobId, pdo] of Object.entries(this.writeMap)) {
            if(pdo.type &lt; 0xF1) {
                const listener = (counter) => {
                    if(pdo.started) {
                        if(pdo.type == 0) {
                            // Acyclic - send only if data changed
                            this.write(cobId, true);
                        }
                        else if(++pdo.counter >= pdo.type) {
                            // Cyclic - send every 'n' sync objects
                            this.write(cobId);
                            pdo.counter = 0;
                        }
                    }
                    else if(counter >= pdo.syncStart) {
                        pdo.started = true;
                        pdo.counter = 0;
                    }
                }

                this.events.push([this.device, 'sync', listener]);
                this.device.on('sync', listener);
            }
            else if(pdo.type == 0xFE) {
                if(pdo.eventTime > 0) {
                    // Send on a timer
                    const timer = setInterval(() => {
                        this.write(cobId);
                    }, pdo.eventTime);

                    this.eventTimers[cobId] = timer;
                }
                else if(pdo.inhibitTime > 0) {
                    // Send on value change, but no faster than inhibit time
                    for(const dataObject of pdo.dataObjects) {
                        const listener = () => {
                            // TODO - fix this, it should keep track of the last
                            // send time and count off that rather than using
                            // a naive timer.
                            if(!this.eventTimers[cobId]) {
                                const timer = setTimeout(() => {
                                    this.eventTimers[cobId] = null;
                                    this.write(cobId);
                                }, pdo.inhibitTime);

                                this.eventTimers[cobId] = timer;
                            }
                        }

                        let entry = this.device.eds.getEntry(dataObject.index);
                        if(entry.subNumber > 0)
                            entry = entry[dataObject.subIndex];

                        this.events.push([entry, 'update', listener]);
                        entry.on('update', listener)
                    }
                }
                else {
                    // Send immediately on value change
                    for(const dataObject of pdo.dataObjects) {
                        const listener = () => {
                            this.write(cobId);
                        }

                        let entry = this.device.eds.getEntry(dataObject.index);
                        if(entry.subNumber > 0)
                            entry = entry[dataObject.subIndex];

                        this.events.push([entry, 'update', listener]);
                        entry.on('update', listener);
                    }
                }
            }
            else {
                throw TypeError(`Unsupported TPDO type (${pdo.type}).`);
            }
        }
    }

    /** Stop TPDO generation. */
    stop() {
        for(const [emitter, eventName, listener] of this.events)
            emitter.removeListener(eventName, listener);

        for(const timer of Object.values(this.eventTimers))
            clearInterval(timer);

        this.eventTimers = {};
        this.events = [];
    }

    /**
     * Service: PDO write
     *
     * @param {number} cobId - mapped TPDO to send.
     * @param {boolean} update - only write if data has changed.
     */
    write(cobId, update=false) {
        const pdo = this.writeMap[cobId];
        if(!pdo)
            throw ReferenceError(`TPDO 0x${cobId.toString(16)} not mapped.`);

        const data = Buffer.alloc(pdo.dataSize);
        let dataOffset = 0;
        let dataUpdated = false;

        for(const dataObject of pdo.dataObjects) {
            let entry = this.device.eds.getEntry(dataObject.index);
            if(entry.subNumber > 0)
                entry = entry[dataObject.subIndex];

            entry.raw.copy(data, dataOffset);
            dataOffset += entry.raw.length;

            const newValue = entry.value;
            if(dataObject.lastValue != newValue) {
                dataObject.lastValue = newValue;
                dataUpdated = true;
            }
        }

        if(!update || dataUpdated)
            this.device.send({ id: cobId, data: data });
    }

    /**
     * Called when a new CAN message is received.
     *
     * @param {object} message - CAN frame.
     * @param {number} message.id - CAN message identifier.
     * @param {Buffer} message.data - CAN message data;
     * @param {number} message.len - CAN message length in bytes.
     * @private
     */
    _onMessage(message) {
        if(message.id &lt; 0x180 || message.id >= 0x580)
            return;

        const updated = [];
        if(message.id in this.receiveMap) {
            const pdo = this.receiveMap[message.id];
            let dataOffset = 0;

            for(const dataObject of pdo.dataObjects) {
                let entry = this.device.dataObjects[dataObject.index];
                if(entry.subNumber > 0)
                    entry = entry[dataObject.subIndex];

                const size = entry.raw.length;
                if(message.data.length &lt; dataOffset + size)
                    continue;

                message.data.copy(entry.raw, 0, dataOffset, dataOffset + size);
                dataOffset += size;

                const newValue = entry.value;
                if(dataObject.lastValue != newValue) {
                    dataObject.lastValue = newValue;
                    updated.push(entry);
                }
            }
        }

        if(updated.length > 0)
            this.device.emit('pdo', updated, message.id);
    }

    /**
     * Parse a PDO communication/mapping parameter.
     *
     * @param {number} index - entry index.
     * @param {DataObject} entry - entry to parse.
     * @returns {object} parsed PDO data.
     * @private
     */
    _parsePDO(index, entry) {
        /* sub-index 1 (mandatory):
         *   bit 0..10      11-bit CAN base frame.
         *   bit 11..28     29-bit CAN extended frame.
         *   bit 29         Frame type.
         *   bit 30         RTR allowed.
         *   bit 31         TPDO valid.
         */
        let cobId = entry[1].value;
        if(!cobId || ((cobId >> 31) &amp; 0x1) == 0x1)
            return;

        if(((cobId >> 29) &amp; 0x1) == 0x1)
            throw TypeError("CAN extended frames are not supported.")

        cobId &amp;= 0x7FF;

        // Add the device id iff the provided id is a base value, e.g. 0x180.
        if((cobId % 0x80) == 0x0)
            cobId |= this.device.id;

        /* sub-index 2 (mandatory):
         *   bit 0..7       Transmission type.
         */
        const transmissionType = entry[2].value;

        /* sub-index 3 (optional):
         *   bit 0..15      Inhibit time.
         */
        const inhibitTime = (entry[3] !== undefined) ? entry[3].value : 0;

        /* sub-index 5 (optional):
         *   bit 0..15      Event timer value.
         */
        const eventTime = (entry[5] !== undefined) ? entry[5].value : 0;

        /* sub-index 6 (optional):
         *   bit 0..7       SYNC start value.
         */
        const syncStart = (entry[6] !== undefined) ? entry[6].value : 0;

        let pdo = {
            cobId:          cobId,
            type:           transmissionType,
            inhibitTime:    inhibitTime,
            eventTime:      eventTime,
            syncStart:      syncStart,
            dataObjects:    [],
            dataSize:       0,
        };

        const mapIndex = index + 0x200;
        const mapEntry = this.device.eds.getEntry(mapIndex);
        if(!mapEntry) {
            throw ReferenceError(
                `Missing TPDO mapping parameter 0x${mapIndex.toString(16)}`);
        }

        if(mapEntry[0].value == 0xFE)
            throw TypeError('SAM-MPDO not supported.');

        if(mapEntry[0].value == 0xFF)
            throw TypeError('DAM-MPDO not supported.');

        if(mapEntry[0].value > 0x40) {
            throw TypeError(
                `Invalid TPDO mapping value (${mapEntry[0].value}).`);
        }

        for(let i = 1; i &lt; mapEntry[0].value + 1; ++i) {
            if(mapEntry[i].raw.length == 0)
                continue;

            /* sub-index 1+:
             *   bit 0..7       Bit length.
             *   bit 8..15      Sub-index.
             *   bit 16..31     Index.
             */
            const dataLength = mapEntry[i].raw.readUInt8(0);
            const dataSubIndex = mapEntry[i].raw.readUInt8(1);
            const dataIndex = mapEntry[i].raw.readUInt16LE(2);

            if(!(dataIndex in this.device.dataObjects))
                continue;

            pdo.dataObjects[i-1] = {
                index:      dataIndex,
                subIndex:   dataSubIndex,
                length:     dataLength,
                lastValue:  undefined,
            };

            pdo.dataSize += dataLength / 8;
        }

        return pdo;
    }
}

module.exports=exports={ Pdo };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Tue Sep 28 2021 16:59:34 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
