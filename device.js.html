<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>device.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/DaxBot/node-canopen" target="_blank" class="menu-item" id="repository" >Repository</a></h2><h3>Classes</h3><ul><li><a href="DataObject.html">DataObject</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataObject.html#.isDataObject">isDataObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#at">at</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#valueOf">valueOf</a></li></ul></li><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Device.html#getRaw">getRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#getRawArray">getRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#getScale">getScale</a></li><li data-type='method' style='display: none;'><a href="Device.html#getScaleArray">getScaleArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValue">getValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValueArray">getValueArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Device.html#mapRemoteNode">mapRemoteNode</a></li><li data-type='method' style='display: none;'><a href="Device.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRaw">setRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRawArray">setRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="Device.html#setScaleArray">setScaleArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#setTransmitFunction">setTransmitFunction</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValue">setValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValueArray">setValueArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Device.html#stop">stop</a></li></ul></li><li><a href="Eds.html">Eds</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Eds.html#.fromFile">fromFile</a></li><li data-type='method' style='display: none;'><a href="Eds.html#.isEds">isEds</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEmcyConsumer">addEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEntry">addEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addHeartbeatConsumer">addHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addReceivePdo">addReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoClientParameter">addSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoServerParameter">addSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSubEntry">addSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addTransmitPdo">addTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#entries">entries</a></li><li data-type='method' style='display: none;'><a href="Eds.html#findEntry">findEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getDeviceName">getDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyCobId">getEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyConsumers">getEmcyConsumers</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyInhibitTime">getEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyValid">getEmcyValid</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEntry">getEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getErrorHistory">getErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getErrorRegister">getErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHardwareVersion">getHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHeartbeatConsumers">getHeartbeatConsumers</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHeartbeatProducerTime">getHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getIdentity">getIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getReceivePdos">getReceivePdos</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSdoClientParameters">getSdoClientParameters</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSdoServerParameters">getSdoServerParameters</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSoftwareVersion">getSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getStatusRegister">getStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSubEntry">getSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncCobId">getSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncCyclePeriod">getSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncGenerationEnable">getSyncGenerationEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncOverflow">getSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeCobId">getTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeConsumerEnable">getTimeConsumerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeProducerEnable">getTimeProducerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTransmitPdos">getTransmitPdos</a></li><li data-type='method' style='display: none;'><a href="Eds.html#keys">keys</a></li><li data-type='method' style='display: none;'><a href="Eds.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Eds.html#pushErrorHistory">pushErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEmcyConsumer">removeEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEntry">removeEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeHeartbeatConsumer">removeHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeReceivePdo">removeReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoClientParameter">removeSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoServerParameter">removeSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSubEntry">removeSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeTransmitPdo">removeTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#reset">reset</a></li><li data-type='method' style='display: none;'><a href="Eds.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceName">setDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyCobId">setEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyInhibitTime">setEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyValid">setEmcyValid</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorHistoryLength">setErrorHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorRegister">setErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHardwareVersion">setHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHeartbeatProducerTime">setHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setIdentity">setIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSoftwareVersion">setSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setStatusRegister">setStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCobId">setSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCyclePeriod">setSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncGenerationEnable">setSyncGenerationEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncOverflow">setSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeCobId">setTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeConsumerEnable">setTimeConsumerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeProducerEnable">setTimeProducerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#values">values</a></li></ul></li><li><a href="EdsError.html">EdsError</a></li><li><a href="Emcy.html">Emcy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Emcy.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#setHistoryLength">setHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#write">write</a></li></ul></li><li><a href="EmcyMessage.html">EmcyMessage</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EmcyMessage.html#.isMessage">isMessage</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toBuffer">toBuffer</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toString">toString</a></li></ul></li><li><a href="Lss.html">Lss</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Lss.html#activateBitTiming">activateBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureBitTiming">configureBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureNodeId">configureNodeId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#fastscan">fastscan</a></li><li data-type='method' style='display: none;'><a href="Lss.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireProductCode">inquireProductCode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireRevisionNumber">inquireRevisionNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireSerialNumber">inquireSerialNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireVendorId">inquireVendorId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Lss.html#setMode">setMode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Lss.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Lss.html#storeConfiguration">storeConfiguration</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeGlobal">switchModeGlobal</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeSelective">switchModeSelective</a></li></ul></li><li><a href="LssError.html">LssError</a></li><li><a href="Nmt.html">Nmt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Nmt.html#addConsumer">addConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#enterPreOperational">enterPreOperational</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumer">getConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumerTime">getConsumerTime</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getNodeState">getNodeState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#removeConsumer">removeConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetCommunication">resetCommunication</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetNode">resetNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#setState">setState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#startNode">startNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stopNode">stopNode</a></li></ul></li><li><a href="Pdo.html">Pdo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Pdo.html#addReceive">addReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#addTransmit">addTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#getReceive">getReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#getTransmit">getTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#removeReceive">removeReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#removeTransmit">removeTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#write">write</a></li></ul></li><li><a href="SdoClient.html">SdoClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoClient.html#addServer">addServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#download">download</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#getServer">getServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#init">init</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#removeServer">removeServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#setBlockSize">setBlockSize</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#upload">upload</a></li></ul></li><li><a href="SdoError.html">SdoError</a><ul class='members'><li data-type='member' style='display: none;'><a href="SdoError.html#.SdoCode">SdoCode</a></li></ul></li><li><a href="SdoServer.html">SdoServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoServer.html#addClient">addClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#getClient">getClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#init">init</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#removeClient">removeClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#setBlockSize">setBlockSize</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#stop">stop</a></li></ul></li><li><a href="Sync.html">Sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Sync.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Sync.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Sync.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Sync.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Sync.html#write">write</a></li></ul></li><li><a href="Time.html">Time</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Time.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Time.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Time.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Time.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Time.html#write">write</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="DataObject.html#event:update">DataObject#update</a></li><li><a href="Device.html#event:emergency">Device#emergency</a></li><li><a href="Device.html#event:lssChangeDeviceId">Device#lssChangeDeviceId</a></li><li><a href="Device.html#event:lssChangeMode">Device#lssChangeMode</a></li><li><a href="Device.html#event:nmtChangeState">Device#nmtChangeState</a></li><li></li><li><a href="Device.html#event:nmtResetCommunication">Device#nmtResetCommunication</a></li><li><a href="Device.html#event:nmtResetNode">Device#nmtResetNode</a></li><li><a href="Device.html#event:pdo">Device#pdo</a></li><li><a href="Device.html#event:sync">Device#sync</a></li><li><a href="Device.html#event:time">Device#time</a></li><li><a href="Eds.html#event:newEntry">Eds#newEntry</a></li><li><a href="Eds.html#event:newRpdo">Eds#newRpdo</a></li><li><a href="Eds.html#event:newSdoClient">Eds#newSdoClient</a></li><li><a href="Eds.html#event:newSdoServer">Eds#newSdoServer</a></li><li><a href="Eds.html#event:newTpdo">Eds#newTpdo</a></li><li></li><li></li><li><a href="Eds.html#event:removeEntry">Eds#removeEntry</a></li><li><a href="Eds.html#event:removeSdoClient">Eds#removeSdoClient</a></li><li><a href="Eds.html#event:removeSdoServer">Eds#removeSdoServer</a></li><li><a href="Emcy.html#event:emergency">Emcy#emergency</a></li><li><a href="Lss.html#event:changeDeviceId">Lss#changeDeviceId</a></li><li><a href="Lss.html#event:changeMode">Lss#changeMode</a></li><li><a href="Nmt.html#event:changeState">Nmt#changeState</a></li><li><a href="Nmt.html#event:heartbeat">Nmt#heartbeat</a></li><li><a href="Nmt.html#event:reset">Nmt#reset</a></li><li><a href="Nmt.html#event:timeout">Nmt#timeout</a></li><li><a href="Pdo.html#event:pdo">Pdo#pdo</a></li><li><a href="Protocol.html#event:message">Protocol#message</a></li><li><a href="Protocol.html#event:start">Protocol#start</a></li><li><a href="Protocol.html#event:stop">Protocol#stop</a></li><li><a href="Sync.html#event:sync">Sync#sync</a></li><li><a href="Time.html#event:time">Time#time</a></li></ul><h3>Interfaces</h3><ul><li><a href="Protocol.html">Protocol</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Protocol.html#addEdsCallback">addEdsCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#addUpdateCallback">addUpdateCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#removeEdsCallback">removeEdsCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#removeUpdateCallback">removeUpdateCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#send">send</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#stop">stop</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#AccessType">AccessType</a></li><li><a href="global.html#calculateCrc">calculateCrc</a></li><li><a href="global.html#DataType">DataType</a></li><li><a href="global.html#dateToTime">dateToTime</a></li><li><a href="global.html#EmcyCode">EmcyCode</a></li><li><a href="global.html#EmcyType">EmcyType</a></li><li><a href="global.html#LssMode">LssMode</a></li><li><a href="global.html#NmtState">NmtState</a></li><li><a href="global.html#ObjectType">ObjectType</a></li><li><a href="global.html#rawToType">rawToType</a></li><li><a href="global.html#timeToDate">timeToDate</a></li><li><a href="global.html#typeToRaw">typeToRaw</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">device.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Implements a CANopen device
 * @author Wilkins White
 * @copyright 2024 Daxbot
 */

const EventEmitter = require('events');
const { deprecate } = require('util');

const { Emcy } = require('./protocol/emcy');
const { Lss } = require('./protocol/lss');
const { Nmt, NmtState } = require('./protocol/nmt');
const { Pdo } = require('./protocol/pdo');
const { SdoClient } = require('./protocol/sdo_client');
const { SdoServer } = require('./protocol/sdo_server');
const { Sync } = require('./protocol/sync');
const { Time } = require('./protocol/time');
const { Eds, EdsError } = require('./eds');

/**
 * A CANopen device.
 *
 * This class represents a single addressable device (or node) on the bus.
 *
 * @param {object} args - arguments.
 * @param {Eds} args.eds - the device's electronic data sheet.
 * @param {number} [args.id] - device identifier [1-127].
 * @param {boolean} [args.loopback] - enable loopback mode.
 * @param {boolean} [args.enableLss] - enable layer setting services.
 */
class Device extends EventEmitter {
    constructor(args = {}) {
        super();
        this._stateListener = null;
        this._resetListener = null;

        if (typeof args.eds === 'string')
            this.eds = Eds.fromFile(args.eds);
        else
            this.eds = args.eds || new Eds();

        if (!Eds.isEds(this.eds))
            throw new EdsError('bad Eds');

        this.protocol = {
            emcy: new Emcy(this.eds),
            lss: new Lss(this.eds),
            nmt: new Nmt(this.eds),
            pdo: new Pdo(this.eds),
            sdoClient: new SdoClient(this.eds),
            sdoServer: new SdoServer(this.eds),
            sync: new Sync(this.eds),
            time: new Time(this.eds),
        };

        for (const obj of Object.values(this.protocol))
            obj.addListener('message', (m) => this.emit('message', m));

        if (args.id !== undefined) {
            if (args.id &lt; 1 || args.id > 0x7F)
                throw RangeError('id must be in range [1-127]');

            this.id = args.id;
        }

        if (args.loopback) {
            this.addListener('message', (m) => {
                /* We use setImmediate here to allow the method that called
                 * send() to run to completion before receive() is processed.
                 */
                setImmediate(() => this.receive(m));
            });
        }

        if (args.enableLss === undefined)
            args.enableLss = this.eds.lssSupported;

        if (args.enableLss) {
            this.lss.addListener('changeDeviceId', (id) => this.id = id);
            this.lss.start();
        }
    }

    /**
     * Accessor for version 5 Eds DataObjects. Do not use.
     *
     * @type {object}
     * @deprecated Use {@link Eds#entries} instead.
     */
    get dataObjects() {
        return this.eds.dataObjects;
    }

    /**
     * The device id.
     *
     * @type {number}
     */
    get id() {
        return this._id;
    }

    set id(value) {
        this._id = value;
        this.nmt.deviceId = value;
    }

    /**
     * The Nmt state.
     *
     * @type {NmtState}
     */
    get state() {
        return this.nmt.state;
    }

    /**
     * The Emcy module.
     *
     * @type {Emcy}
     */
    get emcy() {
        return this.protocol.emcy;
    }

    /**
     * The Lss module.
     *
     * @type {Lss}
     */
    get lss() {
        return this.protocol.lss;
    }

    /**
     * The Nmt module.
     *
     * @type {Nmt}
     */
    get nmt() {
        return this.protocol.nmt;
    }

    /**
     * The Pdo module.
     *
     * @type {Pdo}
     */
    get pdo() {
        return this.protocol.pdo;
    }

    /**
     * The Sdo (client) module.
     *
     * @type {SdoClient}
     */
    get sdo() {
        return this.protocol.sdoClient;
    }

    /**
     * The Sdo (server) module.
     *
     * @type {SdoClient}
     */
    get sdoServer() {
        return this.protocol.sdoServer;
    }

    /**
     * The Sync module.
     *
     * @type {Sync}
     */
    get sync() {
        return this.protocol.sync;
    }

    /**
     * The Time module.
     *
     * @type {Time}
     */
    get time() {
        return this.protocol.time;
    }

    /**
     * Manufacturer hardware version (Object 0x)
     */

    /**
     * Call with each incoming CAN message.
     *
     * @param {object} message - CAN frame.
     * @param {number} message.id - CAN message identifier.
     * @param {Buffer} message.data - CAN message data;
     * @param {number} message.len - CAN message length in bytes.
     */
    receive(message) {
        if (message.id == 0x0) {
            // Reserve COB-ID 0x0 for NMT
            this.nmt.receive(message);
        }
        else {
            for (const obj of Object.values(this.protocol))
                obj.receive(message);
        }
    }

    /**
     * Initialize the device and audit the object dictionary.
     *
     * @since 6.0.0
     */
    start() {
        if (!this.id)
            throw new Error('id must be set');

        if (!this._resetListener) {
            this._resetListener = (resetEds) => this._reset(resetEds);
            this.nmt.addListener('reset', this._resetListener);
        }

        if (!this._stateListener) {
            this._stateListener = (state) => this._changeState(state);
            this.nmt.addListener('changeState', this._stateListener);
        }

        this.nmt.start();
    }

    /**
     * Cleanup timers and shutdown the device.
     *
     * @since 6.0.0
     */
    stop() {
        try {
            this.nmt.removeListener('reset', this._resetListener);
            this._resetListener = null;

            this.nmt.removeListener('changeState', this._stateListener);
            this._stateListener = null;
        }
        catch (e) { /* ignore */ }

        for (const obj of Object.values(this.protocol))
            obj.stop();
    }

    /**
     * Map a remote node's EDS file on to this Device.
     *
     * This method provides an easy way to set up communication with another
     * device. Most EDS transmit/producer entries will be mapped to their local
     * receive/consumer analogues. Note that this method will heavily modify
     * the Device's internal EDS file.
     *
     * This may be called multiple times to map more than one EDS.
     *
     * @param {object} args - method arguments.
     * @param {number} args.id - the remote node's CAN identifier.
     * @param {Eds | string} args.eds - the server's EDS.
     * @param {number} [args.dataStart] - start index for SDO entries.
     * @param {boolean} [args.skipEmcy] - Skip EMCY producer -> consumer.
     * @param {boolean} [args.skipNmt] - Skip NMT producer -> consumer.
     * @param {boolean} [args.skipPdo] - Skip PDO transmit -> receive.
     * @param {boolean} [args.skipSdo] - Skip SDO server -> client.
     * @since 6.0.0
     */
    mapRemoteNode(args = {}) {
        let eds = args.eds;
        if (typeof eds === 'string')
            eds = Eds.fromFile(eds);

        if (!args.skipEmcy) {
            // Map EMCY producer -> consumer
            const cobId = eds.getEmcyCobId();
            if (cobId)
                this.eds.addEmcyConsumer(cobId);
        }

        if (!args.skipNmt) {
            // Map heartbeat producer -> consumer
            const ms = eds.getHeartbeatProducerTime();
            if (ms) {
                if (!args.id)
                    throw new ReferenceError('id required to map NMT');

                this.eds.addHeartbeatConsumer(args.id, ms * 2);
            }
        }

        if (!args.skipSdo) {
            for (const client of eds.getSdoServerParameters()) {

                const clientId = client.deviceId;
                if (clientId > 0 &amp;&amp; clientId !== this.id)
                    continue;

                if (!args.id)
                    throw new ReferenceError('id required to map SDO');

                const cobIdTx = client.cobIdRx; // client -> server
                const cobIdRx = client.cobIdTx; // server -> client

                this.eds.addSdoClientParameter(args.id, cobIdTx, cobIdRx);
            }
        }

        if (!args.skipPdo) {
            let dataIndex = args.dataStart || 0x2000;
            if (dataIndex &lt; 0x2000)
                throw new RangeError('dataStart must be >= 0x2000');

            const mapped = [];
            for (const pdo of eds.getTransmitPdos()) {

                const dataObjects = [];
                for (let obj of pdo.dataObjects) {
                    // Find the next open SDO index
                    while (this.eds.getEntry(dataIndex) !== undefined) {
                        if (dataIndex >= 0xFFFF)
                            throw new RangeError('dataIndex must be &lt;= 0xFFFF');

                        dataIndex += 1;
                    }

                    // If this is a subObject, then get the parent instead
                    const subIndex = obj.subIndex;
                    if (subIndex !== null)
                        obj = eds.getEntry(obj.index);

                    if (mapped.includes(obj.index))
                        continue; // Already mapped

                    mapped.push(obj.index);

                    // Add data object to device EDS
                    this.eds.addEntry(dataIndex, obj);
                    for (let j = 1; j &lt; obj.subNumber; ++j)
                        this.eds.addSubEntry(dataIndex, j, obj[j]);

                    // Prepare to map the new data object
                    if (subIndex) {
                        dataObjects.push(
                            this.eds.getSubEntry(dataIndex, subIndex));
                    }
                    else {
                        dataObjects.push(
                            this.eds.getEntry(dataIndex));
                    }
                }

                pdo.dataObjects = dataObjects;
                this.eds.addReceivePdo(pdo);
            }
        }
    }

    /**
     * Get the value of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @returns {number | bigint | string | Date} entry value.
     */
    getValue(index) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        return entry.value;
    }

    /**
     * Get the value of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - sub-object index.
     * @returns {number | bigint | string | Date} entry value.
     */
    getValueArray(index, subIndex) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        return entry.value;
    }

    /**
     * Get the raw value of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @returns {Buffer} entry data.
     */
    getRaw(index) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        return entry.raw;
    }

    /**
     * Get the raw value of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - sub-object index.
     * @returns {Buffer} entry data.
     */
    getRawArray(index, subIndex) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        return entry.raw;
    }

    /**
     * Get the scale factor of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @returns {number | bigint | string | Date} entry value.
     */
    getScale(index) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        return entry.scaleFactor;
    }

    /**
     * Get the scale factor of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - sub-object index.
     * @returns {number | bigint | string | Date} entry value.
     */
    getScaleArray(index, subIndex) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        return entry.scaleFactor;
    }

    /**
     * Set the value of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number | bigint | string | Date} value - value to set.
     */
    setValue(index, value) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        entry.value = value;
    }

    /**
     * Set the value of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - array sub-index to set;
     * @param {number | bigint | string | Date} value - value to set.
     */
    setValueArray(index, subIndex, value) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        entry.value = value;
    }

    /**
     * Set the raw value of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {Buffer} raw - raw Buffer to set.
     */
    setRaw(index, raw) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        entry.raw = raw;
    }

    /**
     * Set the raw value of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - sub-object index.
     * @param {Buffer} raw - raw Buffer to set.
     */
    setRawArray(index, subIndex, raw) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        entry.raw = raw;
    }

    /**
     * Set the scale factor of an EDS entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} scaleFactor - value to set.
     * @since 6.0.0
     */
    setScale(index, scaleFactor) {
        const entry = this.eds.getEntry(index);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index} does not exist`);
        }

        entry.scaleFactor = scaleFactor;
    }

    /**
     * Set the scale factor of an EDS sub-entry.
     *
     * @param {number | string} index - index or name of the entry.
     * @param {number} subIndex - array sub-index to set;
     * @param {number} scaleFactor - value to set.
     * @since 6.0.0
     */
    setScaleArray(index, subIndex, scaleFactor) {
        const entry = this.eds.getSubEntry(index, subIndex);
        if (!entry) {
            if (typeof index === 'number')
                index = '0x' + index.toString(16);

            throw new EdsError(`entry ${index}[${subIndex}] does not exist`);
        }

        entry.scaleFactor = scaleFactor;
    }

    /**
     * Reset the Device.
     *
     * @param {boolean} [resetEds] - if true, then perform an Eds reset.
     * @listens Nmt#reset
     * @private
     */
    _reset(resetEds = false) {
        if (resetEds)
            this.eds.reset();

        setImmediate(() => {
            // Stop all modules
            this.stop();

            // Re-start Nmt and transition to PRE_OPERATIONAL
            this.start();
        });
    }

    /**
     * Called on Nmt#changeState
     *
     * @param {NmtState} state - new nmt state.
     * @listens Nmt#changeState
     * @private
     */
    _changeState(state) {
        switch (state) {
            case NmtState.PRE_OPERATIONAL:
                // Start all...
                this.emcy.start();
                this.sdo.start();
                this.sdoServer.start();
                this.sync.start();
                this.time.start();

                // ... except Pdo
                this.pdo.stop();
                break;

            case NmtState.OPERATIONAL:
                // Start all
                this.emcy.start();
                this.sdo.start();
                this.sdoServer.start();
                this.sync.start();
                this.time.start();
                this.pdo.start();
                break;

            case NmtState.INITIALIZING:
            case NmtState.STOPPED:
                // Stop all except Nmt
                this.emcy.stop();
                this.sdo.stop();
                this.sdoServer.stop();
                this.sync.stop();
                this.time.stop();
                this.pdo.stop();
                break;
        }
    }
}

////////////////////////////////// Deprecated //////////////////////////////////

/**
 * Initialize the device and audit the object dictionary. Additionally this
 * method will enable deprecated Device level events.
 *
 * @deprecated Use {@link Device#start} instead.
 * @function
 */
Device.prototype.init = deprecate(
    function () {
        this.emcy.addListener('emergency', ({ cobId, em }) => {
            /**
             * Emcy object consumed (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#emergency
             * @deprecated Use {@link Emcy#event:emergency} instead.
             */
            this.emit('emergency', (cobId &amp; 0xF), em);
        });

        this.nmt.addListener('reset', (resetNode) => {
            if (resetNode) {
                /**
                 * NMT reset node (deprecated).
                 *
                 * This event needs to be enabled by calling
                 * {@link Device#init} before it will fire.
                 *
                 * @event Device#nmtResetNode
                 * @deprecated Use {@link Nmt#event:reset} instead.
                 */
                this.emit('nmtResetNode');
            }
            else {
                /**
                 * NMT reset communication (deprecated).
                 *
                 * This event needs to be enabled by calling
                 * {@link Device#init} before it will fire.
                 *
                 * @event Device#nmtResetCommunication
                 * @deprecated Use {@link Nmt#event:reset} instead.
                 */
                this.emit('nmtResetCommunication');
            }

            this._reset(resetNode);
        });

        this.nmt.addListener('changeState', (state) => {
            /**
             * NMT state changed (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#nmtChangeState
             * @deprecated Use {@link Nmt#event:changeState} or {@link Nmt#event:heartbeat} instead.
             */
            this.emit('nmtChangeState', this.deviceId, state);
            this._changeState(state);
        });

        this.nmt.addListener('heartbeat', ({ deviceId, state }) => {
            this.emit('nmtChangeState', deviceId, state);
        });

        this.nmt.addListener('timeout', (deviceId) => {
            /**
             * NMT consumer timeout (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#nmtChangeState
             * @deprecated Use {@link Nmt#event:timeout} instead.
             */
            this.emit('nmtTimeout', deviceId);
        });

        this.pdo.addListener('pdo', (pdo) => {
            /**
             * PDO received (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#pdo
             * @deprecated Use {@link Pdo#event:pdo} instead.
             */
            this.emit('pdo', pdo.dataObjects, pdo.cobId);
        });

        this.sync.addListener('sync', (count) => {
            /**
             * Sync object consumed (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#sync
             * @deprecated Use {@link Sync#event:sync} instead.
             */
            this.emit('sync', count);
        });

        this.time.addListener('time', (date) => {
            /**
             * Time object consumed (deprecated).
             *
             * This event needs to be enabled by calling
             * {@link Device#init} before it will fire.
             *
             * @event Device#time
             * @deprecated Use {@link Time#event:time} instead.
             */
            this.emit('time', date);
        });

        if (this.lss) {
            this.lss.addListener('changeMode', (mode) => {
                /**
                 * Change of LSS mode (deprecated).
                 *
                 * This event needs to be enabled by calling
                 * {@link Device#init} before it will fire.
                 *
                 * @event Device#lssChangeMode
                 * @deprecated Use {@link Lss#event:changeMode} instead.
                 */
                this.emit('lssChangeMode', mode);
            });

            this.lss.addListener('changeDeviceId', (id) => {
                /**
                 * Change of device id (deprecated).
                 *
                 * This event needs to be enabled by calling
                 * {@link Device#init} before it will fire.
                 *
                 * @event Device#lssChangeDeviceId
                 * @deprecated Use {@link Lss#event:changeDeviceId} instead.
                 */
                this.emit('lssChangeDeviceId', id);
            });
        }

        this.emcy.deviceId = this.id;

        for (const obj of Object.values(this.protocol)) {
            if (typeof obj.init === 'function')
                obj.init();
        }

    }, 'Device.init() is deprecated. Use Device.start() instead.');

/**
 * Set the send function.
 *
 * This method has been deprecated. Add a listener for the 'message' event
 * instead.
 *
 * @param {Function} send - send function.
 * @deprecated Use {@link https://nodejs.org/api/events.html#emitteroneventname-listener|Device.on('message')} instead.
 * @function
 */
Device.prototype.setTransmitFunction = deprecate(
    function (send) {
        this.addListener('message', send);
    }, "Device.setTransmitFunction() is deprecated. Use Device.on('message') instead.");

/**
 * Old name for mapRemoteNode() that was available in the development version.
 *
 * @deprecated
 * @ignore
 */
Device.prototype.mapEds = deprecate(
    function (args) {
        if (args.serverId !== undefined)
            args.id = args.serverId;

        this.mapRemoteNode(args);
    }, 'Device.mapEds() is deprecated. Use Device.mapRemoteNode() instead.');

module.exports = exports = Device;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
