<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>protocol/sdo_server.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/DaxBot/node-canopen" target="_blank" class="menu-item" id="repository" >Repository</a></h2><h3>Classes</h3><ul><li><a href="DataObject.html">DataObject</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataObject.html#.isDataObject">isDataObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#at">at</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#valueOf">valueOf</a></li></ul></li><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Device.html#getRaw">getRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#getRawArray">getRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#getScale">getScale</a></li><li data-type='method' style='display: none;'><a href="Device.html#getScaleArray">getScaleArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValue">getValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#getValueArray">getValueArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Device.html#mapRemoteNode">mapRemoteNode</a></li><li data-type='method' style='display: none;'><a href="Device.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRaw">setRaw</a></li><li data-type='method' style='display: none;'><a href="Device.html#setRawArray">setRawArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="Device.html#setScaleArray">setScaleArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#setTransmitFunction">setTransmitFunction</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValue">setValue</a></li><li data-type='method' style='display: none;'><a href="Device.html#setValueArray">setValueArray</a></li><li data-type='method' style='display: none;'><a href="Device.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Device.html#stop">stop</a></li></ul></li><li><a href="Eds.html">Eds</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Eds.html#.fromFile">fromFile</a></li><li data-type='method' style='display: none;'><a href="Eds.html#.isEds">isEds</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEmcyConsumer">addEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEntry">addEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addHeartbeatConsumer">addHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addReceivePdo">addReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoClientParameter">addSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoServerParameter">addSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSubEntry">addSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addTransmitPdo">addTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#entries">entries</a></li><li data-type='method' style='display: none;'><a href="Eds.html#findEntry">findEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getDeviceName">getDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyCobId">getEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyConsumers">getEmcyConsumers</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyInhibitTime">getEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEmcyValid">getEmcyValid</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEntry">getEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getErrorHistory">getErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getErrorRegister">getErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHardwareVersion">getHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHeartbeatConsumers">getHeartbeatConsumers</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getHeartbeatProducerTime">getHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getIdentity">getIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getReceivePdos">getReceivePdos</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSdoClientParameters">getSdoClientParameters</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSdoServerParameters">getSdoServerParameters</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSoftwareVersion">getSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getStatusRegister">getStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSubEntry">getSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncCobId">getSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncCyclePeriod">getSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncGenerationEnable">getSyncGenerationEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSyncOverflow">getSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeCobId">getTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeConsumerEnable">getTimeConsumerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTimeProducerEnable">getTimeProducerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getTransmitPdos">getTransmitPdos</a></li><li data-type='method' style='display: none;'><a href="Eds.html#keys">keys</a></li><li data-type='method' style='display: none;'><a href="Eds.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Eds.html#pushErrorHistory">pushErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEmcyConsumer">removeEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEntry">removeEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeHeartbeatConsumer">removeHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeReceivePdo">removeReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoClientParameter">removeSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoServerParameter">removeSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSubEntry">removeSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeTransmitPdo">removeTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#reset">reset</a></li><li data-type='method' style='display: none;'><a href="Eds.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceName">setDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyCobId">setEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyInhibitTime">setEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyValid">setEmcyValid</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorHistoryLength">setErrorHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorRegister">setErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHardwareVersion">setHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHeartbeatProducerTime">setHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setIdentity">setIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSoftwareVersion">setSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setStatusRegister">setStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCobId">setSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCyclePeriod">setSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncGenerationEnable">setSyncGenerationEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncOverflow">setSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeCobId">setTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeConsumerEnable">setTimeConsumerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeProducerEnable">setTimeProducerEnable</a></li><li data-type='method' style='display: none;'><a href="Eds.html#values">values</a></li></ul></li><li><a href="EdsError.html">EdsError</a></li><li><a href="Emcy.html">Emcy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Emcy.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#setHistoryLength">setHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#write">write</a></li></ul></li><li><a href="EmcyMessage.html">EmcyMessage</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EmcyMessage.html#.isMessage">isMessage</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toBuffer">toBuffer</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toString">toString</a></li></ul></li><li><a href="Lss.html">Lss</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Lss.html#activateBitTiming">activateBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureBitTiming">configureBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureNodeId">configureNodeId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#fastscan">fastscan</a></li><li data-type='method' style='display: none;'><a href="Lss.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireProductCode">inquireProductCode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireRevisionNumber">inquireRevisionNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireSerialNumber">inquireSerialNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireVendorId">inquireVendorId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Lss.html#setMode">setMode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Lss.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Lss.html#storeConfiguration">storeConfiguration</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeGlobal">switchModeGlobal</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeSelective">switchModeSelective</a></li></ul></li><li><a href="LssError.html">LssError</a></li><li><a href="Nmt.html">Nmt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Nmt.html#addConsumer">addConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#enterPreOperational">enterPreOperational</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumer">getConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumerTime">getConsumerTime</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getNodeState">getNodeState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#removeConsumer">removeConsumer</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetCommunication">resetCommunication</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetNode">resetNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#setState">setState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#startNode">startNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stopNode">stopNode</a></li></ul></li><li><a href="Pdo.html">Pdo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Pdo.html#addReceive">addReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#addTransmit">addTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#getReceive">getReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#getTransmit">getTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#removeReceive">removeReceive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#removeTransmit">removeTransmit</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#write">write</a></li></ul></li><li><a href="SdoClient.html">SdoClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoClient.html#_getServer">_getServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#addServer">addServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#download">download</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#getServer">getServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#init">init</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#removeServer">removeServer</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#setBlockSize">setBlockSize</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#upload">upload</a></li></ul></li><li><a href="SdoError.html">SdoError</a><ul class='members'><li data-type='member' style='display: none;'><a href="SdoError.html#.SdoCode">SdoCode</a></li></ul></li><li><a href="SdoServer.html">SdoServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoServer.html#addClient">addClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#getClient">getClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#init">init</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#removeClient">removeClient</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#setBlockInterval">setBlockInterval</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#setBlockSize">setBlockSize</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#stop">stop</a></li></ul></li><li><a href="Sync.html">Sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Sync.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Sync.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Sync.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Sync.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Sync.html#write">write</a></li></ul></li><li><a href="Time.html">Time</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Time.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Time.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Time.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Time.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Time.html#write">write</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="DataObject.html#event:update">DataObject#update</a></li><li><a href="Device.html#event:emergency">Device#emergency</a></li><li><a href="Device.html#event:lssChangeDeviceId">Device#lssChangeDeviceId</a></li><li><a href="Device.html#event:lssChangeMode">Device#lssChangeMode</a></li><li><a href="Device.html#event:nmtChangeState">Device#nmtChangeState</a></li><li></li><li><a href="Device.html#event:nmtResetCommunication">Device#nmtResetCommunication</a></li><li><a href="Device.html#event:nmtResetNode">Device#nmtResetNode</a></li><li><a href="Device.html#event:pdo">Device#pdo</a></li><li><a href="Device.html#event:sync">Device#sync</a></li><li><a href="Device.html#event:time">Device#time</a></li><li><a href="Eds.html#event:newEntry">Eds#newEntry</a></li><li><a href="Eds.html#event:newRpdo">Eds#newRpdo</a></li><li><a href="Eds.html#event:newSdoClient">Eds#newSdoClient</a></li><li><a href="Eds.html#event:newSdoServer">Eds#newSdoServer</a></li><li><a href="Eds.html#event:newTpdo">Eds#newTpdo</a></li><li></li><li></li><li><a href="Eds.html#event:removeEntry">Eds#removeEntry</a></li><li><a href="Eds.html#event:removeSdoClient">Eds#removeSdoClient</a></li><li><a href="Eds.html#event:removeSdoServer">Eds#removeSdoServer</a></li><li><a href="Emcy.html#event:emergency">Emcy#emergency</a></li><li><a href="Lss.html#event:changeDeviceId">Lss#changeDeviceId</a></li><li><a href="Lss.html#event:changeMode">Lss#changeMode</a></li><li><a href="Nmt.html#event:changeState">Nmt#changeState</a></li><li><a href="Nmt.html#event:heartbeat">Nmt#heartbeat</a></li><li><a href="Nmt.html#event:reset">Nmt#reset</a></li><li><a href="Nmt.html#event:timeout">Nmt#timeout</a></li><li><a href="Pdo.html#event:pdo">Pdo#pdo</a></li><li><a href="Protocol.html#event:message">Protocol#message</a></li><li><a href="Protocol.html#event:start">Protocol#start</a></li><li><a href="Protocol.html#event:stop">Protocol#stop</a></li><li><a href="Sync.html#event:sync">Sync#sync</a></li><li><a href="Time.html#event:time">Time#time</a></li></ul><h3>Interfaces</h3><ul><li><a href="Protocol.html">Protocol</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Protocol.html#addEdsCallback">addEdsCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#addUpdateCallback">addUpdateCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#removeEdsCallback">removeEdsCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#removeUpdateCallback">removeUpdateCallback</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#send">send</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#stop">stop</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#AccessType">AccessType</a></li><li><a href="global.html#calculateCrc">calculateCrc</a></li><li><a href="global.html#DataType">DataType</a></li><li><a href="global.html#dateToTime">dateToTime</a></li><li><a href="global.html#EmcyCode">EmcyCode</a></li><li><a href="global.html#EmcyType">EmcyType</a></li><li><a href="global.html#LssMode">LssMode</a></li><li><a href="global.html#NmtState">NmtState</a></li><li><a href="global.html#ObjectType">ObjectType</a></li><li><a href="global.html#rawToType">rawToType</a></li><li><a href="global.html#timeToDate">timeToDate</a></li><li><a href="global.html#typeToRaw">typeToRaw</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">protocol/sdo_server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Implements the CANopen Service Data Object (SDO) protocol server.
 * @author Wilkins White
 * @copyright 2024 Daxbot
 */

const Protocol = require('./protocol');
const { DataObject, Eds } = require('../eds');
const { AccessType } = require('../types');
const { SdoCode, SdoTransfer, ClientCommand, ServerCommand } = require('./sdo');
const calculateCrc = require('../functions/crc');
const rawToType = require('../functions/raw_to_type');
const { deprecate } = require('util');

/**
 * CANopen SDO protocol handler (Server).
 *
 * The service data object (SDO) protocol uses a client-server structure where
 * a client can initiate the transfer of data from the server's object
 * dictionary. An SDO is transfered as a sequence of segments with basic
 * error checking.
 *
 * @param {Eds} eds - parent device.
 * @see CiA301 'Service data object (SDO)' (§7.2.4)
 * @implements {Protocol}
 */
class SdoServer extends Protocol {
    constructor(eds) {
        super(eds);
        this.transfers = {};
        this._blockSize = 127;
        this._blockInterval = null;
    }

    /**
     * Number of segments per block when serving block transfers.
     *
     * @type {number}
     */
    get blockSize() {
        return this._blockSize;
    }

    /**
     * Time delay between each segment during a block transfer.
     *
     * @type {number}
     * @since 6.2.0
     */
    get blockInterval() {
        return this._blockInterval;
    }

    /**
     * Set the number of segments per block when serving block transfers.
     *
     * @param {number} value - block size [1-127].
     * @since 6.0.0
     */
    setBlockSize(value) {
        if (value &lt; 1 || value > 127)
            throw RangeError('blockSize must be in range [1-127]');

        this._blockSize = value;
    }

    /**
     * Set the time delay between each segment during a block transfer.
     *
     * @param {number} value - block interval in milliseconds.
     * @since 6.2.0
     */
    setBlockInterval(value) {
        if(value &lt; 0)
            throw RangeError('blockInterval must be positive or zero');

        this._blockInterval = value;
    }

    /**
     * Start the module.
     *
     * @override
     */
    start() {
        if(!this.started) {
            this.transfers = {};
            for (const client of this.eds.getSdoServerParameters())
                this._addClient(client);

            this.addEdsCallback('newSdoClient',
                (client) => this._addClient(client));

            this.addEdsCallback('removeSdoClient',
                (client) => this._removeClient(client));

            super.start();
        }
    }

    /**
     * Stop the module.
     *
     * @override
     */
    stop() {
        if(this.started) {
            this.removeEdsCallback('newSdoClient');
            this.removeEdsCallback('removeSdoClient');

            for (const client of this.eds.getSdoServerParameters())
                this._removeClient(client);

            super.stop();
        }
    }

    /**
     * Call when a new CAN message is received.
     *
     * @param {object} message - CAN frame.
     * @param {number} message.id - CAN message identifier.
     * @param {Buffer} message.data - CAN message data;
     * @override
     */
    receive({ id, data }) {
        // Handle transfers as a server (local object dictionary)
        const client = this.transfers[id];
        if (client === undefined)
            return;

        if (client.blockTransfer) {
            // Block transfer in progress
            if ((data[0] &amp; 0x7f) === client.blockSequence + 1) {
                client.data = Buffer.concat([client.data, data.slice(1)]);
                client.blockSequence++;
                if (data[0] &amp; 0x80) {
                    client.blockFinished = true;
                    client.blockTransfer = false;
                }
            }

            if (client.blockSequence > 127) {
                this._abortTransfer(client, SdoCode.BAD_BLOCK_SEQUENCE);
                return;
            }

            // Awknowledge block
            if (client.blockFinished
                || client.blockSequence == this.blockSize) {

                const header = (ServerCommand.BLOCK_DOWNLOAD &lt;&lt; 5)
                    | (2 &lt;&lt; 0); // Block download response

                const sendBuffer = Buffer.alloc(8);
                sendBuffer.writeUInt8(header);
                sendBuffer.writeInt8(client.blockSequence, 1);
                sendBuffer.writeUInt8(this.blockSize, 2);

                this.send(client.cobId, sendBuffer);

                // Reset sequence
                client.blockSequence = 0;
            }

            client.refresh();
            return;
        }

        switch (data[0] >> 5) {
            case ClientCommand.DOWNLOAD_SEGMENT:
                this._downloadSegment(client, data);
                break;
            case ClientCommand.DOWNLOAD_INITIATE:
                this._downloadInitiate(client, data);
                break;
            case ClientCommand.UPLOAD_INITIATE:
                this._uploadInitiate(client, data);
                break;
            case ClientCommand.UPLOAD_SEGMENT:
                this._uploadSegment(client, data);
                break;
            case ClientCommand.ABORT:
                client.reject();
                break;
            case ClientCommand.BLOCK_UPLOAD:
                switch (data[0] &amp; 0x3) {
                    case 0:
                        // Initiate upload
                        this._blockUploadInitiate(client, data);
                        break;
                    case 1:
                        // End upload
                        this._blockUploadEnd(client);
                        break;
                    case 2:
                        // Confirm block
                        this._blockUploadConfirm(client, data);
                        break;
                    case 3:
                        // Start upload
                        this._blockUploadProcess(client);
                        break;
                }
                break;
            case ClientCommand.BLOCK_DOWNLOAD:
                this._blockDownload(client, data);
                break;
            default:
                this._abortTransfer(client, SdoCode.BAD_COMMAND);
                break;
        }
    }

    /**
     * Add an SDO client.
     *
     * @param {object} args - SDO client parameters.
     * @param {number} args.cobIdTx - COB-ID server -> client.
     * @param {number} args.cobIdRx - COB-ID client -> server.
     * @private
     */
    _addClient({ cobIdTx, cobIdRx }) {
        this.transfers[cobIdRx] = new SdoTransfer({ cobId: cobIdTx });
    }

    /**
     * Remove an SDO client.
     *
     * @param {object} args - SDO client parameters.
     * @param {number} args.cobIdRx - COB-ID client -> server.
     * @private
     */
    _removeClient({ cobIdRx }) {
        const transfer = this.transfers[cobIdRx];
        if(transfer) {
            if (transfer.active)
                this._abortTransfer(transfer, SdoCode.DEVICE_STATE);

            delete this.transfers[cobIdRx];
        }
    }

    /**
     * Handle ClientCommand.DOWNLOAD_INITIATE.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _downloadInitiate(client, data) {
        client.index = data.readUInt16LE(1);
        client.subIndex = data.readUInt8(3);

        if (data[0] &amp; 0x02) {
            // Expedited client
            let entry = this.eds.getEntry(client.index);
            if (entry === undefined) {
                this._abortTransfer(client, SdoCode.OBJECT_UNDEFINED);
                return;
            }

            if (entry.subNumber > 0) {
                entry = entry[client.subIndex];
                if (entry === undefined) {
                    this._abortTransfer(client, SdoCode.BAD_SUB_INDEX);
                    return;
                }
            }

            if (entry.accessType == AccessType.CONSTANT
                || entry.accessType == AccessType.READ_ONLY) {
                this._abortTransfer(client, SdoCode.READ_ONLY);
                return;
            }

            const count = (data[0] &amp; 1) ? (4 - ((data[0] >> 2) &amp; 3)) : 4;
            const raw = Buffer.alloc(count);
            data.copy(raw, 0, 4, count + 4);

            const value = rawToType(raw, entry.dataType);
            if (entry.highLimit !== undefined &amp;&amp; value > entry.highLimit) {
                this._abortTransfer(client, SdoCode.VALUE_HIGH);
                return;
            }

            if (entry.lowLimit !== undefined &amp;&amp; value &lt; entry.lowLimit) {
                this._abortTransfer(client, SdoCode.VALUE_LOW);
                return;
            }

            entry.raw = raw;

            const sendBuffer = Buffer.alloc(8);
            sendBuffer.writeUInt8(ServerCommand.DOWNLOAD_INITIATE &lt;&lt; 5);
            sendBuffer.writeUInt16LE(client.index, 1);
            sendBuffer.writeUInt8(client.subIndex, 3);

            this.send(client.cobId, sendBuffer);
        }
        else {
            // Segmented client
            client.data = Buffer.alloc(0);
            client.size = 0;
            client.toggle = 0;

            const sendBuffer = Buffer.alloc(8);
            sendBuffer.writeUInt8(ServerCommand.DOWNLOAD_INITIATE &lt;&lt; 5);
            sendBuffer.writeUInt16LE(client.index, 1);
            sendBuffer.writeUInt8(client.subIndex, 3);

            this.send(client.cobId, sendBuffer);

            client.start();
        }
    }

    /**
     * Handle ClientCommand.UPLOAD_INITIATE.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _uploadInitiate(client, data) {
        client.index = data.readUInt16LE(1);
        client.subIndex = data.readUInt8(3);

        let entry = this.eds.getEntry(client.index);
        if (entry === undefined) {
            this._abortTransfer(client, SdoCode.OBJECT_UNDEFINED);
            return;
        }

        if (entry.subNumber > 0) {
            entry = entry[client.subIndex];
            if (entry === undefined) {
                this._abortTransfer(client, SdoCode.BAD_SUB_INDEX);
                return;
            }
        }

        if (entry.accessType == AccessType.WRITE_ONLY) {
            this._abortTransfer(client, SdoCode.WRITE_ONLY);
            return;
        }

        if (entry.size &lt;= 4) {
            // Expedited client
            const sendBuffer = Buffer.alloc(8);
            const header = (ServerCommand.UPLOAD_INITIATE &lt;&lt; 5)
                | ((4 - entry.size) &lt;&lt; 2)
                | 0x2;

            sendBuffer.writeUInt8(header, 0);
            sendBuffer.writeUInt16LE(client.index, 1);
            sendBuffer.writeUInt8(client.subIndex, 3);

            entry.raw.copy(sendBuffer, 4);

            if (entry.size &lt; 4)
                sendBuffer[0] |= ((4 - entry.size) &lt;&lt; 2) | 0x1;

            this.send(client.cobId, sendBuffer);
        }
        else {
            // Segmented client
            client.data = Buffer.from(entry.raw);
            client.size = 0;
            client.toggle = 0;

            const sendBuffer = Buffer.alloc(8);
            const header = (ServerCommand.UPLOAD_INITIATE &lt;&lt; 5) | 0x1;

            sendBuffer.writeUInt8(header, 0);
            sendBuffer.writeUInt16LE(client.index, 1);
            sendBuffer.writeUInt8(client.subIndex, 3);
            sendBuffer.writeUInt32LE(client.data.length, 4);

            this.send(client.cobId, sendBuffer);

            client.start();
        }
    }

    /**
     * Handle ClientCommand.UPLOAD_SEGMENT.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _uploadSegment(client, data) {
        if ((data[0] &amp; 0x10) != (client.toggle &lt;&lt; 4)) {
            this._abortTransfer(client, SdoCode.TOGGLE_BIT);
            return;
        }

        const sendBuffer = Buffer.alloc(8);
        let count = Math.min(7, (client.data.length - client.size));
        client.data.copy(
            sendBuffer, 1, client.size, client.size + count);

        let header = (client.toggle &lt;&lt; 4) | (7 - count) &lt;&lt; 1;
        if (client.size == client.data.length) {
            header |= 1;
            client.resolve();
        }

        sendBuffer.writeUInt8(header, 0);
        client.toggle ^= 1;
        client.size += count;

        this.send(client.cobId, sendBuffer);

        client.refresh();
    }

    /**
     * Handle ClientCommand.DOWNLOAD_SEGMENT.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _downloadSegment(client, data) {
        if ((data[0] &amp; 0x10) != (client.toggle &lt;&lt; 4)) {
            this._abortTransfer(client, SdoCode.TOGGLE_BIT);
            return;
        }

        const count = (7 - ((data[0] >> 1) &amp; 0x7));
        const payload = data.slice(1, count + 1);
        const size = client.data.length + count;

        client.data = Buffer.concat([client.data, payload], size);

        if (data[0] &amp; 1) {
            let entry = this.eds.getEntry(client.index);
            if (entry === undefined) {
                this._abortTransfer(client, SdoCode.OBJECT_UNDEFINED);
                return;
            }

            if (entry.subNumber > 0) {
                entry = entry[client.subIndex];
                if (entry === undefined) {
                    this._abortTransfer(client, SdoCode.BAD_SUB_INDEX);
                    return;
                }
            }

            if (entry.accessType == AccessType.CONSTANT
                || entry.accessType == AccessType.READ_ONLY) {
                this._abortTransfer(client, SdoCode.READ_ONLY);
                return;
            }

            const raw = Buffer.alloc(size);
            client.data.copy(raw);

            const value = rawToType(raw, entry.dataType);
            if (entry.highLimit !== undefined &amp;&amp; value > entry.highLimit) {
                this._abortTransfer(client, SdoCode.VALUE_HIGH);
                return;
            }

            if (entry.lowLimit !== undefined &amp;&amp; value &lt; entry.lowLimit) {
                this._abortTransfer(client, SdoCode.VALUE_LOW);
                return;
            }

            entry.raw = raw;

            client.resolve();
        }

        const sendBuffer = Buffer.alloc(8);
        const header = (ServerCommand.DOWNLOAD_SEGMENT &lt;&lt; 5)
            | (client.toggle &lt;&lt; 4);

        sendBuffer.writeUInt8(header);
        client.toggle ^= 1;

        this.send(client.cobId, sendBuffer);

        client.refresh();
    }

    /**
     * Download a data block.
     *
     * Sub-blocks are scheduled on the event loop to avoid blocking during
     * large transfers.
     *
     * @param {SdoTransfer} client - SDO context.
     * @fires Protocol#message
     * @private
     */
    _blockUploadProcess(client) {
        if (!client.active) {
            // Transfer was interrupted
            return;
        }

        const sendBuffer = Buffer.alloc(8);
        const offset = 7 * (client.blockSequence
            + (client.blockCount * client.blockSize));

        sendBuffer[0] = ++client.blockSequence;
        if ((offset + 7) >= client.data.length) {
            sendBuffer[0] |= 0x80; // Last block
            client.blockFinished = true;
        }

        client.data.copy(sendBuffer, 1, offset, offset + 7);
        this.send(client.cobId, sendBuffer);

        client.refresh();

        if (!client.blockFinished &amp;&amp; client.blockSequence &lt; client.blockSize) {
            if(this._blockInterval === 0) {
                // Fire segments as fast as possible
                setImmediate(() => this._blockUploadProcess(client));
            }
            else {
                // If blockInterval is undefined, then default to 1 ms
                setTimeout(() => this._blockUploadProcess(client),
                    this._blockInterval || 1);
            }
        }
    }

    /**
     * Handle ClientCommand.BLOCK_UPLOAD.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _blockUploadInitiate(client, data) {
        client.index = data.readUInt16LE(1);
        client.subIndex = data.readUInt8(3);
        client.blockSize = data.readUInt32LE(4);
        client.blockCrc = !!(data[0] &amp; (1 &lt;&lt; 2));

        let entry = this.eds.getEntry(client.index);
        if (entry === undefined) {
            this._abortTransfer(client, SdoCode.OBJECT_UNDEFINED);
            return;
        }

        if (entry.subNumber > 0) {
            entry = entry[client.subIndex];
            if (entry === undefined) {
                this._abortTransfer(client, SdoCode.BAD_SUB_INDEX);
                return;
            }
        }

        if (entry.accessType == AccessType.WRITE_ONLY) {
            this._abortTransfer(client, SdoCode.WRITE_ONLY);
            return;
        }

        client.data = Buffer.from(entry.raw);
        client.size = 0;
        client.blockCount = 0;
        client.blockSequence = 0;
        client.blockFinished = false;

        // Confirm transfer
        const header = (ServerCommand.BLOCK_UPLOAD &lt;&lt; 5)
            | (1 &lt;&lt; 2)      // CRC supported
            | (1 &lt;&lt; 1);     // Data size indicated

        const sendBuffer = Buffer.alloc(8);
        sendBuffer.writeUInt8(header);
        sendBuffer.writeUInt16LE(client.index, 1);
        sendBuffer.writeUInt8(client.subIndex, 3);
        sendBuffer.writeUInt32LE(client.data.length, 4);

        this.send(client.cobId, sendBuffer);

        client.start();
    }

    /**
     * Handle ClientCommand.BLOCK_UPLOAD.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _blockUploadConfirm(client, data) {
        // Check that all sub-blocks were received.
        if (data[1] === client.blockSequence) {
            client.blockCount += 1;
            client.blockSequence = 0;

            if (client.blockFinished) {
                // End block upload
                const sendBuffer = Buffer.alloc(8);

                let header = (ServerCommand.BLOCK_UPLOAD &lt;&lt; 5)
                    | (1 &lt;&lt; 0); // End block upload

                const emptyBytes = client.data.length % 7;
                if (emptyBytes)
                    header |= (7 - emptyBytes) &lt;&lt; 2;

                sendBuffer.writeUInt8(header);

                // Write CRC (if supported)
                if (client.blockCrc) {
                    const crcValue = calculateCrc(client.data);
                    sendBuffer.writeUInt16LE(crcValue, 1);
                }

                this.send(client.cobId, sendBuffer);

                client.refresh();
                return;
            }
        }

        // Update block size for next transfer.
        client.blockSize = data[2];
        if (client.blockSize &lt; 1 || client.blockSize > 127) {
            this._abortTransfer(client, SdoCode.BAD_BLOCK_SIZE);
            return;
        }

        // Upload next block
        this._blockUploadProcess(client);
    }

    /**
     * Handle ClientCommand.BLOCK_UPLOAD.
     *
     * @param {SdoTransfer} client - SDO context.
     * @fires Protocol#message
     * @private
     */
    _blockUploadEnd(client) {
        client.resolve();
    }

    /**
     * Handle ClientCommand.BLOCK_DOWNLOAD.
     *
     * @param {SdoTransfer} client - SDO context.
     * @param {Buffer} data - message data.
     * @fires Protocol#message
     * @private
     */
    _blockDownload(client, data) {
        if (client.blockFinished) {
            // Number of bytes that do not contain segment data
            const count = (data[0] >> 2) &amp; 7;
            if (count) {
                const size = client.data.length - count;
                client.data = client.data.slice(0, size);
            }

            // Check size
            if (client.data.length &lt; client.size) {
                this._abortTransfer(client, SdoCode.DATA_SHORT);
                return;
            }

            if (client.data.length > client.size) {
                this._abortTransfer(client, SdoCode.DATA_LONG);
                return;
            }

            // Check CRC (if supported)
            if (client.blockCrc) {
                const crcValue = data.readUInt16LE(1);
                if (crcValue !== calculateCrc(client.data)) {
                    this._abortTransfer(client, SdoCode.BAD_BLOCK_CRC);
                    return;
                }
            }

            // Get entry
            let entry = this.eds.getEntry(client.index);
            if (entry === undefined) {
                this._abortTransfer(client, SdoCode.OBJECT_UNDEFINED);
                return;
            }

            if (entry.subNumber > 0) {
                entry = entry[client.subIndex];
                if (entry === undefined) {
                    this._abortTransfer(client, SdoCode.BAD_SUB_INDEX);
                    return;
                }
            }

            // Check that the entry has write access
            if (entry.accessType == AccessType.CONSTANT
                || entry.accessType == AccessType.READ_ONLY) {
                this._abortTransfer(client, SdoCode.READ_ONLY);
                return;
            }

            // Check value limits
            const value = rawToType(client.data, entry.dataType);
            if (entry.highLimit !== undefined &amp;&amp; value > entry.highLimit) {
                this._abortTransfer(client, SdoCode.VALUE_HIGH);
                return;
            }

            if (entry.lowLimit !== undefined &amp;&amp; value &lt; entry.lowLimit) {
                this._abortTransfer(client, SdoCode.VALUE_LOW);
                return;
            }

            // Write new data
            entry.raw = client.data;

            // End transfer
            const header = (ServerCommand.BLOCK_DOWNLOAD &lt;&lt; 5)
                | (1 &lt;&lt; 0); // End block download

            const sendBuffer = Buffer.alloc(8);
            sendBuffer.writeUInt8(header);

            this.send(client.cobId, sendBuffer);

            client.resolve();
        }
        else {
            // Initiate block transfer
            client.index = data.readUInt16LE(1);
            client.subIndex = data.readUInt8(3);
            client.size = data.readUInt32LE(4);
            client.data = Buffer.alloc(0);
            client.blockTransfer = true;
            client.blockSequence = 0;
            client.blockFinished = false;
            client.blockCrc = !!(data[0] &amp; (1 &lt;&lt; 2));

            // Confirm transfer
            const header = (ServerCommand.BLOCK_DOWNLOAD &lt;&lt; 5)
                | (1 &lt;&lt; 2); // CRC supported

            const sendBuffer = Buffer.alloc(8);
            sendBuffer.writeUInt8(header);
            sendBuffer.writeUInt16LE(client.index, 1);
            sendBuffer.writeUInt8(client.subIndex, 3);
            sendBuffer.writeUInt8(this.blockSize, 4);

            this.send(client.cobId, sendBuffer);

            client.start();
        }
    }

    /**
     * Abort a transfer.
     *
     * @param {SdoTransfer} transfer - SDO context.
     * @param {SdoCode} code - SDO abort code.
     * @fires Protocol#message
     * @private
     */
    _abortTransfer(transfer, code) {
        const sendBuffer = Buffer.alloc(8);
        sendBuffer.writeUInt8(0x80);
        sendBuffer.writeUInt16LE(transfer.index, 1);
        sendBuffer.writeUInt8(transfer.subIndex, 3);
        sendBuffer.writeUInt32LE(code, 4);
        this.send(transfer.cobId, sendBuffer);
        transfer.reject(code);
    }
}

////////////////////////////////// Deprecated //////////////////////////////////

/**
 * Initialize the device and audit the object dictionary.
 *
 * @deprecated Use {@link SdoServer#start} instead.
 * @function
 */
SdoServer.prototype.init = deprecate(function () {
    this.start();
}, 'SdoServer.init() is deprecated. Use SdoServer.start() instead.');

/**
 * Get an SDO client parameter entry.
 *
 * @param {number} clientId - server COB-ID of the entry to get.
 * @returns {DataObject | null} the matching entry.
 * @deprecated Use {@link Eds#getSdoServerParameters} instead.
 * @function
 */
SdoServer.prototype.getClient = deprecate(
    function (clientId) {
        for (let [index, entry] of this.eds.entries()) {
            index = parseInt(index, 16);
            if (index &lt; 0x1200 || index > 0x127F)
                continue;

            if (entry[3] !== undefined &amp;&amp; entry[3].value === clientId)
                return entry;
        }

        return null;
    }, 'SdoServer.getClient() is deprecated. Use Eds.getSdoServerParameters() instead.');

/**
 * Add an SDO server parameter entry.
 *
 * @param {number} clientId - client COB-ID to add.
 * @param {number} cobIdTx - Sdo COB-ID for outgoing messages (to client).
 * @param {number} cobIdRx - Sdo COB-ID for incoming messages (from client).
 * @deprecated Use {@link Eds#addSdoServerParameter} instead.
 * @function
 */
SdoServer.prototype.addClient = deprecate(
    function (clientId, cobIdTx=0x580, cobIdRx=0x600) {
        if((cobIdTx &amp; 0x7F) == 0x0)
            cobIdTx |= clientId;

        if((cobIdRx &amp; 0x7F) == 0x0)
            cobIdRx |= clientId;

        this.eds.addSdoServerParameter(clientId, cobIdTx, cobIdRx);
    }, 'SdoServer.addClient() is deprecated. Use Eds.addSdoServerParameter() instead.');

/**
 * Remove an SDO server parameter entry.
 *
 * @param {number} clientId - client COB-ID of the entry to remove.
 * @deprecated Use {@link Eds#removeSdoServerParameter} instead.
 * @function
 */
SdoServer.prototype.removeClient = deprecate(
    function (clientId) {
        this.eds.removeSdoServerParameter(clientId);
    }, 'SdoServer.removeClient() is deprecated. Use Eds.removeSdoServerParameter() instead.');

module.exports = exports = { SdoServer };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
