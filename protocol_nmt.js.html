<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>protocol/nmt.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/DaxBot/node-canopen" target="_blank" class="menu-item" id="repository" >Repository</a></h2><h3>Classes</h3><ul><li><a href="DataObject.html">DataObject</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataObject.html#.isDataObject">isDataObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#addSubObject">addSubObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#at">at</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#removeSubObject">removeSubObject</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#toString">toString</a></li><li data-type='method' style='display: none;'><a href="DataObject.html#valueOf">valueOf</a></li></ul></li><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Device.html#getDeviceName">getDeviceName</a></li><li data-type='method' style='display: none;'><a href="Device.html#getDeviceType">getDeviceType</a></li><li data-type='method' style='display: none;'><a href="Device.html#getHardwareVersion">getHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Device.html#getSoftwareVersion">getSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Device.html#getStatusRegister">getStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Device.html#mapRemoteNode">mapRemoteNode</a></li><li data-type='method' style='display: none;'><a href="Device.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Device.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Device.html#stop">stop</a></li></ul></li><li><a href="Eds.html">Eds</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Eds.html#.fromFile">fromFile</a></li><li data-type='method' style='display: none;'><a href="Eds.html#.isEds">isEds</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEmcyConsumer">addEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addEntry">addEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addHeartbeatConsumer">addHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addReceivePdo">addReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoClientParameter">addSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSdoServerParameter">addSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addSubEntry">addSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#addTransmitPdo">addTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#findEntry">findEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getEntry">getEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getRaw">getRaw</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getRawArray">getRawArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getScale">getScale</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getScaleArray">getScaleArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getSubEntry">getSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getValue">getValue</a></li><li data-type='method' style='display: none;'><a href="Eds.html#getValueArray">getValueArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#load">load</a></li><li data-type='method' style='display: none;'><a href="Eds.html#pushErrorHistory">pushErrorHistory</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEmcyConsumer">removeEmcyConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeEntry">removeEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeHeartbeatConsumer">removeHeartbeatConsumer</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeReceivePdo">removeReceivePdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoClientParameter">removeSdoClientParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSdoServerParameter">removeSdoServerParameter</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeSubEntry">removeSubEntry</a></li><li data-type='method' style='display: none;'><a href="Eds.html#removeTransmitPdo">removeTransmitPdo</a></li><li data-type='method' style='display: none;'><a href="Eds.html#reset">reset</a></li><li data-type='method' style='display: none;'><a href="Eds.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceName">setDeviceName</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setDeviceType">setDeviceType</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyCobId">setEmcyCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setEmcyInhibitTime">setEmcyInhibitTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorHistoryLength">setErrorHistoryLength</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setErrorRegister">setErrorRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHardwareVersion">setHardwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setHeartbeatProducerTime">setHeartbeatProducerTime</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setIdentity">setIdentity</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setRaw">setRaw</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setRawArray">setRawArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setScale">setScale</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setScaleArray">setScaleArray</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSoftwareVersion">setSoftwareVersion</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setStatusRegister">setStatusRegister</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCobId">setSyncCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncCyclePeriod">setSyncCyclePeriod</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setSyncOverflow">setSyncOverflow</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setTimeCobId">setTimeCobId</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setValue">setValue</a></li><li data-type='method' style='display: none;'><a href="Eds.html#setValueArray">setValueArray</a></li></ul></li><li><a href="EdsError.html">EdsError</a></li><li><a href="Emcy.html">Emcy</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Emcy.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Emcy.html#write">write</a></li></ul></li><li><a href="EmcyMessage.html">EmcyMessage</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EmcyMessage.html#.isMessage">isMessage</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toBuffer">toBuffer</a></li><li data-type='method' style='display: none;'><a href="EmcyMessage.html#toString">toString</a></li></ul></li><li><a href="Lss.html">Lss</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Lss.html#activateBitTiming">activateBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureBitTiming">configureBitTiming</a></li><li data-type='method' style='display: none;'><a href="Lss.html#configureNodeId">configureNodeId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#fastscan">fastscan</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireProductCode">inquireProductCode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireRevisionNumber">inquireRevisionNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireSerialNumber">inquireSerialNumber</a></li><li data-type='method' style='display: none;'><a href="Lss.html#inquireVendorId">inquireVendorId</a></li><li data-type='method' style='display: none;'><a href="Lss.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Lss.html#setMode">setMode</a></li><li data-type='method' style='display: none;'><a href="Lss.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Lss.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Lss.html#storeConfiguration">storeConfiguration</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeGlobal">switchModeGlobal</a></li><li data-type='method' style='display: none;'><a href="Lss.html#switchModeSelective">switchModeSelective</a></li></ul></li><li><a href="LssError.html">LssError</a></li><li><a href="Nmt.html">Nmt</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Nmt.html#enterPreOperational">enterPreOperational</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getConsumerTime">getConsumerTime</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#getNodeState">getNodeState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetCommunication">resetCommunication</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#resetNode">resetNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#setState">setState</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#startNode">startNode</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Nmt.html#stopNode">stopNode</a></li></ul></li><li><a href="Pdo.html">Pdo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Pdo.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Pdo.html#write">write</a></li></ul></li><li><a href="Protocol.html">Protocol</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Protocol.html#send">send</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Protocol.html#stop">stop</a></li></ul></li><li><a href="SdoClient.html">SdoClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoClient.html#download">download</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="SdoClient.html#upload">upload</a></li></ul></li><li><a href="SdoError.html">SdoError</a><ul class='members'><li data-type='member' style='display: none;'><a href="SdoError.html#.SdoCode">SdoCode</a></li></ul></li><li><a href="SdoServer.html">SdoServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SdoServer.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#start">start</a></li><li data-type='method' style='display: none;'><a href="SdoServer.html#stop">stop</a></li></ul></li><li><a href="Sync.html">Sync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Sync.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Sync.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Sync.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Sync.html#write">write</a></li></ul></li><li><a href="Time.html">Time</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Time.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="Time.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Time.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Time.html#write">write</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="DataObject.html#event:update">DataObject#update</a></li><li><a href="Emcy.html#event:emergency">Emcy#emergency</a></li><li><a href="Lss.html#event:changeDeviceId">Lss#changeDeviceId</a></li><li><a href="Lss.html#event:changeMode">Lss#changeMode</a></li><li><a href="Nmt.html#event:changeState">Nmt#changeState</a></li><li><a href="Nmt.html#event:reset">Nmt#reset</a></li><li><a href="Nmt.html#event:timeout">Nmt#timeout</a></li><li><a href="Pdo.html#event:pdo">Pdo#pdo</a></li><li><a href="Protocol.html#event:message">Protocol#message</a></li><li><a href="Protocol.html#event:start">Protocol#start</a></li><li><a href="Protocol.html#event:stop">Protocol#stop</a></li><li><a href="Sync.html#event:sync">Sync#sync</a></li><li><a href="Time.html#event:time">Time#time</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AccessType">AccessType</a></li><li><a href="global.html#calculateCrc">calculateCrc</a></li><li><a href="global.html#DataType">DataType</a></li><li><a href="global.html#dateToTime">dateToTime</a></li><li><a href="global.html#EmcyCode">EmcyCode</a></li><li><a href="global.html#EmcyType">EmcyType</a></li><li><a href="global.html#LssMode">LssMode</a></li><li><a href="global.html#NmtState">NmtState</a></li><li><a href="global.html#ObjectType">ObjectType</a></li><li><a href="global.html#rawToType">rawToType</a></li><li><a href="global.html#timeToDate">timeToDate</a></li><li><a href="global.html#typeToRaw">typeToRaw</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">protocol/nmt.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Implements the CANopen Network Managements (NMT) protocol.
 * @author Wilkins White
 * @copyright 2024 Daxbot
 */

const Protocol = require('./protocol');
const { DataObject, Eds, EdsError } = require('../eds');
const { deprecate } = require('util');

/**
 * NMT internal states.
 *
 * @enum {number}
 * @see CiA301 "NMT states" (§7.3.2.2)
 */
const NmtState = {
    /** The CANopen device's parameters are set to their power-on values. */
    INITIALIZING: 0,

    /**
     * Communication via SDOs is possible, but PDO communication is not
     * allowed. PDO configuration may be performed by the application.
     */
    PRE_OPERATIONAL: 127,

    /**
     * All communication objects are active. Access to certain aspects of the
     * application may be limited.
     */
    OPERATIONAL: 5,

    /** No communication except for node guarding and heartbeat.  */
    STOPPED: 4,
};

/**
 * NMT commands.
 *
 * @enum {number}
 * @see CiA301 "Node control protocols" (§7.2.8.3.1)
 * @private
 */
const NmtCommand = {
    /** Switch target device to {@link NmtState.OPERATIONAL}. */
    ENTER_OPERATIONAL: 1,

    /** Switch target device to {@link NmtState.STOPPED}. */
    ENTER_STOPPED: 2,

    /** Switch target device to {@link NmtState.PRE_OPERATIONAL}. */
    ENTER_PRE_OPERATIONAL: 128,

    /** Reset the target device. */
    RESET_NODE: 129,

    /** Reset the target device's communication. */
    RESET_COMMUNICATION: 130,
};

/**
 * CANopen NMT protocol handler.
 *
 * The network management (NMT) protocol follows a producer-consumer structure
 * where NMT objects are used to initialze, start, monitor, reset, or stop
 * nodes. All CANopen devices are considered NMT consumers with one device
 * fulfilling the role of NMT producer.
 *
 * This class implements the NMT node control services and tracks the device's
 * current NMT consumer state.
 *
 * @param {Eds} eds - Eds object.
 * @see CiA301 "Network management" (§7.2.8)
 */
class Nmt extends Protocol {
    constructor(eds) {
        super();

        if (!Eds.isEds(eds))
            throw new TypeError('not an Eds');

        this.eds = eds;
        this.deviceId = null;
        this.heartbeatMap = {};
        this.heartbeatTimers = {};
        this._state = NmtState.INITIALIZING;
    }

    /**
     * Device NMT state.
     *
     * @type {NmtState}
     */
    get state() {
        return this._state;
    }

    set state(value) {
        this.setState(value);
    }

    /**
     * Producer heartbeat time in ms (Object 0x1017).
     *
     * @type {number}
     */
    get producerTime() {
        if(this._producerTime !== undefined)
            return this._producerTime;

        const obj1017 = this.eds.getEntry(0x1017);
        if (obj1017)
            return obj1017.value;

        return null;
    }

    set producerTime(value) {
        this._producerTime = value;
    }

    /**
     * Consumer heartbeat time (Object 0x1016).
     *
     * [{ deviceId, heartbeatTime } ... ]
     *
     * @type {Array&lt;object>}
     */
    get consumers() {
        const consumers = [];

        const obj1016 = this.eds.getEntry(0x1016);
        if (obj1016) {
            const maxSubIndex = obj1016[0].value;
            for (let i = 1; i &lt;= maxSubIndex; ++i) {
                const subObj = obj1016.at(i);
                if(!subObj)
                    continue;

                const heartbeatTime = subObj.raw.readUInt16LE(0);
                const deviceId = subObj.raw.readUInt8(2);

                if (deviceId > 0 &amp;&amp; deviceId &lt;= 127)
                    consumers.push({ deviceId, heartbeatTime });
            }
        }

        return consumers;
    }

    /**
     * Begin heartbeat generation.
     *
     * @fires Protocol#start
     */
    start() {
        if (this.state !== NmtState.INITIALIZING)
            return;

        this.heartbeatMap = {};
        for (const { deviceId, heartbeatTime } of this.consumers) {
            this.heartbeatMap[deviceId] = {
                state: null,
                interval: heartbeatTime,
            };
        }

        const producerTime = this.producerTime;
        if (producerTime !== null) {
            if (producerTime === 0)
                throw new EdsError('producerTime may not be 0');

            // Start heartbeat timer
            this.heartbeatTimers[0] = setInterval(() => {
                if (this.deviceId)
                    this._sendHeartbeat(this.deviceId);
            }, producerTime);
        }

        this.state = NmtState.PRE_OPERATIONAL;
        super.start();
    }

    /**
     * Stop heartbeat generation.
     *
     * @fires Protocol#stop
     */
    stop() {
        for (const timer of Object.values(this.heartbeatTimers))
            clearTimeout(timer);

        this.state = NmtState.INITIALIZING;
        this.heartbeatTimers = {};
        super.stop();
    }

    /**
     * Set the Nmt state.
     *
     * @param {NmtState} state - new state.
     * @fires Nmt#changeState
     */
    setState(state) {
        if (state !== this._state) {
            const deviceId = this.deviceId;
            const oldState = this.state;
            this._state = state;
            this._emitChangeState(deviceId, state, oldState);
        }
    }

    /**
     * Get the consumer heartbeat time for a device.
     *
     * @param {number} deviceId - device COB-ID to get.
     * @returns {number | null} the consumer heartbeat time or null.
     */
    getConsumerTime(deviceId) {
        const subObj = this.eds.getHeartbeatConsumer(deviceId);
        if(subObj)
            return subObj.raw.readUInt16LE(0);

        return null;
    }

    /**
     * Get a device's NMT state.
     *
     * @param {number} [deviceId] - CAN identifier.
     * @param {number} [timeout] - How long to wait (ms).
     * @returns {Promise&lt;NmtState | null>} The node NMT state.
     */
    async getNodeState(deviceId, timeout) {
        if (!deviceId)
            return this.state;

        let interval = this.getConsumerTime(deviceId);
        if (interval === null)
            throw new ReferenceError(`NMT consumer ${deviceId} does not exist`);

        if (!timeout)
            timeout = (interval * 2);

        return new Promise((resolve) => {
            const start = Date.now();

            let timeoutTimer = null;
            let intervalTimer = null;

            timeoutTimer = setTimeout(() => {
                const heartbeat = this.heartbeatMap[deviceId];
                if (heartbeat &amp;&amp; heartbeat.last > start)
                    resolve(heartbeat.state);
                else
                    resolve(null);

                clearInterval(intervalTimer);
            }, timeout);

            intervalTimer = setInterval(() => {
                const heartbeat = this.heartbeatMap[deviceId];
                if (heartbeat &amp;&amp; heartbeat.last > start) {
                    clearTimeout(timeoutTimer);
                    clearInterval(intervalTimer);
                    resolve(heartbeat.state);
                }
            }, (interval / 2));
        });
    }

    /**
     * Service: start remote node.
     *
     * Change the state of NMT consumer(s) to NMT state operational.
     *
     * @param {number} [nodeId] - id of node or 0 for broadcast.
     * @fires Protocol#message
     * @fires Nmt#changeState
     * @see CiA301 "Service start remote node" (§7.2.8.2.1.2)
     */
    startNode(nodeId) {
        this._sendNmt(nodeId, NmtCommand.ENTER_OPERATIONAL);
    }

    /**
     * Service: stop remote node.
     *
     * Change the state of NMT consumer(s) to NMT state stopped.
     *
     * @param {number} [nodeId] - id of node or 0 for broadcast.
     * @fires Protocol#message
     * @fires Nmt#changeState
     * @see CiA301 "Service stop remote node" (§7.2.8.2.1.3)
     */
    stopNode(nodeId) {
        this._sendNmt(nodeId, NmtCommand.ENTER_STOPPED);
    }

    /**
     * Service: enter pre-operational.
     *
     * Change the state of NMT consumer(s) to NMT state pre-operational.
     *
     * @param {number} [nodeId] - id of node or 0 for broadcast.
     * @fires Protocol#message
     * @fires Nmt#changeState
     * @see CiA301 "Service enter pre-operational" (§7.2.8.2.1.4)
     */
    enterPreOperational(nodeId) {
        this._sendNmt(nodeId, NmtCommand.ENTER_PRE_OPERATIONAL);
    }

    /**
     * Service: reset node.
     *
     * Reset the application of NMT consumer(s).
     *
     * @param {number} [nodeId] - id of node or 0 for broadcast.
     * @fires Protocol#message
     * @fires Nmt#reset
     * @see CiA301 "Service reset node" (§7.2.8.2.1.5)
     */
    resetNode(nodeId) {
        this._sendNmt(nodeId, NmtCommand.RESET_NODE);
    }

    /**
     * Service: reset communication.
     *
     * Reset communication of NMT consumer(s).
     *
     * @param {number} [nodeId] - id of node or 0 for broadcast.
     * @fires Protocol#message
     * @fires Nmt#reset
     * @see CiA301 "Service reset communication" (§7.2.8.2.1.6)
     */
    resetCommunication(nodeId) {
        this._sendNmt(nodeId, NmtCommand.RESET_COMMUNICATION);
    }

    /**
     * Call when a new CAN message is received.
     *
     * @param {object} message - CAN frame.
     * @param {number} message.id - CAN message identifier.
     * @param {Buffer} message.data - CAN message data;
     * @fires Nmt#changeState
     * @fires Nmt#timeout
     */
    receive({ id, data }) {
        if ((id &amp; 0x7FF) == 0x0) {
            const nodeId = data[1];
            if (nodeId == 0 || nodeId == this.deviceId)
                this._handleNmt(data[0]);
        }
        else if ((id &amp; 0x700) == 0x700) {
            const deviceId = id &amp; 0x7F;
            if (deviceId in this.heartbeatMap) {
                this.heartbeatMap[deviceId].last = Date.now();

                const newState = data[0];
                const oldState = this.heartbeatMap[deviceId].state;
                if (newState !== oldState) {
                    this.heartbeatMap[deviceId].state = newState;
                    this._emitChangeState(deviceId, newState, oldState);
                }

                if (!this.heartbeatTimers[deviceId]) {
                    // First heartbeat - start timer.
                    const interval = this.heartbeatMap[deviceId].interval;
                    this.heartbeatTimers[deviceId] = setTimeout(() => {
                        this._emitTimeout(deviceId);
                        this.heartbeatMap[deviceId].state = null;
                        this.heartbeatTimers[deviceId] = null;
                    }, interval);
                }
                else {
                    this.heartbeatTimers[deviceId].refresh();
                }
            }
        }
    }

    /////////////////////////////// Private ////////////////////////////////

    /**
     * Serve an NMT command object.
     *
     * @param {number} nodeId - id of node or 0 for broadcast.
     * @param {NmtCommand} command - NMT command to serve.
     * @fires Protocol#message
     * @private
     */
    _sendNmt(nodeId, command) {
        if (nodeId === undefined) {
            // Handle internally and return
            this._handleNmt(command);
            return;
        }

        if (!nodeId) {
            // Broadcast
            this._handleNmt(command);
        }

        this.send(0x0, Buffer.from([command, nodeId]));
    }

    /**
     * Serve a Heartbeat object.
     *
     * @param {number} deviceId - device identifier [1-127].
     * @fires Protocol#message
     * @private
     */
    _sendHeartbeat(deviceId) {
        this.send(0x700 + deviceId, Buffer.from([this.state]));
    }

    /**
     * Parse an NMT command.
     *
     * @param {NmtCommand} command - NMT command to handle.
     * @fires Nmt#reset
     * @private
     */
    _handleNmt(command) {
        switch (command) {
            case NmtCommand.ENTER_OPERATIONAL:
                this.state = NmtState.OPERATIONAL;
                break;
            case NmtCommand.ENTER_STOPPED:
                this.state = NmtState.STOPPED;
                break;
            case NmtCommand.ENTER_PRE_OPERATIONAL:
                this.state = NmtState.PRE_OPERATIONAL;
                break;
            case NmtCommand.RESET_NODE:
                this._emitReset(true);
                this.state = NmtState.INITIALIZING;
                break;
            case NmtCommand.RESET_COMMUNICATION:
                this._emitReset(true);
                this.state = NmtState.INITIALIZING;
                break;
        }
    }

    /**
     * Emit the reset event.
     *
     * @param {boolean} resetNode - true if a full reset was requested.
     * @fires Nmt#reset
     * @private
     */
    _emitReset(resetNode) {
        /**
         * A reset was requested.
         *
         * @event Nmt#reset
         * @type {boolean}
         */
        this.emit('reset', resetNode);
    }

    /**
     * Emit the changeState event.
     *
     * @param {number} deviceId - the device identifier.
     * @param {NmtState} newState - the new Nmt state.
     * @param {NmtState} oldState - the old Nmt state.
     * @fires Nmt#changeState
     * @private
     */
    _emitChangeState(deviceId, newState, oldState) {
        /**
         * The Nmt state changed.
         *
         * @event Nmt#changeState
         * @type {object}
         * @property {number} deviceId - the device that changed.
         * @property {NmtState} newState - the new Nmt state.
         * @property {NmtState} oldState - the previous Nmt state.
         */
        this.emit('changeState', {
            deviceId,
            newState,
            oldState,
        });
    }

    /**
     * Emit the timeout event.
     *
     * @param {number} deviceId - the device identifier.
     * @fires Nmt#timeout
     * @private
     */
    _emitTimeout(deviceId) {
        /**
         * A consumer heartbeat timed out.
         *
         * @event Nmt#timeout
         * @type {number}
         */
        this.emit('timeout', deviceId);
    }

    ////////////////////////////// Deprecated //////////////////////////////

    /**
     * Initialize the device and audit the object dictionary.
     *
     * @deprecated
     * @ignore
     */
    init() {
        deprecate(() => this.start(),
            'init() is deprecated. Use start() instead.');
    }

    /**
     * Get an entry from 0x1016 (Consumer heartbeat time).
     *
     * @param {number} deviceId - device COB-ID of the entry to get.
     * @returns {DataObject | null} the matching entry or null.
     * @deprecated
     * @ignore
     */
    getConsumer(deviceId) {
        return deprecate(() => {
            const obj1016 = this.getEntry(0x1016);
            if(obj1016) {
                const maxSubIndex = obj1016[0].value;
                for (let i = 1; i &lt;= maxSubIndex; ++i) {
                    const subObj = obj1016.at(i);
                    if(!subObj)
                        continue;

                    if(subObj.raw.readUInt8(2) === deviceId)
                        return subObj;
                }
            }

            return null;
        }, 'getConsumer() is deprecated. Use getConsumerTime instead.');
    }

    /**
     * Add an entry to 0x1016 (Consumer heartbeat time).
     *
     * @param {number} deviceId - device COB-ID to add.
     * @param {number} timeout - milliseconds before a timeout is reported.
     * @param {number} [subIndex] - sub-index to store the entry, optional.
     * @deprecated
     * @ignore
     */
    addConsumer(deviceId, timeout, subIndex) {
        const opt = { subIndex };
        deprecate(() => this.eds.addHeartbeatConsumer(deviceId, timeout, opt),
            'addConsumer() is deprecated. Use Eds method instead.');

    }

    /**
     * Remove an entry from 0x1016 (Consumer heartbeat time).
     *
     * @param {number} deviceId - device COB-ID of the entry to remove.
     * @deprecated
     * @ignore
     */
    removeConsumer(deviceId) {
        deprecate(() => this.eds.removeHeartbeatConsumer(deviceId),
            'removeConsumer() is deprecated. Use Eds method isntead.');
    }
}

module.exports = exports = { NmtState, Nmt };
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
